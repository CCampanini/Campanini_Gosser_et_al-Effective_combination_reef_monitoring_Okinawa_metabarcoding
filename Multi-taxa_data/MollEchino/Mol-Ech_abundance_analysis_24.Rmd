---
title: "Data analysis of mollusks and echinoderms abundance"
author: "Claudia Campanini"
date: '2022-06-21'
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# INTRODUCTION

Mollusk and echinoderm abundance by class extracted by analyzing photos
collected on belt transects during surveys at different sites along
Okinawa and Aka Island. Belt transect area (1 replicate) was 25 m^2^ for
mollusks and 50 m^2 for echinoderms. Sites exposure to anthropogenic
pressure was previously estimated using the scale from DiBattista et
al., 2019.

```{r, message= FALSE}
#load libraries
library(here)
library(dplyr)
library(ggplot2)
library(readxl)   # to import excel datasets
library(magrittr)
```

# Mollusks | Abundance estimates

Merge raw files from each site in a single data frame

```{r}
mol_raw <-  list.files(path = here("Multi-taxa_data","MollEchino","Mol_raw"),
             pattern = "*.xlsx",
             full.names =T) %>%  
  sapply(read_excel,
         simplify = F, 
         USE.NAMES = F) 

names(mol_raw) = c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2")

mol_raw_df <- as.data.frame(do.call(rbind, mol_raw))
str(mol_raw_df)

rm(mol_raw)
```

Format the data frame for analysis 

```{r}
mol_raw_df$CLASS <- replace(mol_raw_df$CLASS,mol_raw_df$CLASS=="-",NA)
mol_raw_df[,c(1:4,7)] <- lapply(mol_raw_df[,c(1:4,7)], as.factor)
mol_raw_df$site <-ordered(mol_raw_df$site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))
mol_raw_df[,11] <- as.numeric(mol_raw_df[,11])
str(mol_raw_df)
```

Extract abundance by class per transect (replicate) from the data frame

```{r}
library(tidyr) #to use the "separate" function
library(janitor) #to use the tabyl function

mol_raw_df <- mol_raw_df[!is.na(mol_raw_df$transect),]

mol_class <- mol_raw_df[!is.na(mol_raw_df$CLASS),] %>% tabyl(transect, CLASS, show_missing_levels = FALSE)
```
 
Add empty lines for transects with no records 

```{r}
str(mol_class)
mol_class$transect <- as.character(mol_class$transect)
mol_class <- rbind(mol_class, 
                   c("AW_S3", 0, 0 , 0),
                   c("S2_D1", 0, 0 , 0),
                   c("G1_D3", 0, 0 , 0))
```

Add site_depth column and remove "Cephalopoda"

```{r}
mol_class <- mol_class %>% 
  separate(transect, c("site", "depth_rep")) %>% 
  mutate(transect = mol_class$transect )

mol_class$depth <- gsub("[[:digit:]]", "", mol_class$depth_rep) #remove the number from depth_rep from Alphanumeric Character String Using gsub() Function

mol_class <- mol_class %>% 
  mutate(site_depth = paste(site, depth, sep='_'))

mol_class$depth_rep <- NULL
mol_class$Cephalopoda <- NULL
```


Add pressure score column and define the appropriate class for each column

```{r}
mol_class <- mol_class %>% 
       mutate(pressure = case_when(site == 'HI' | 
                                   site == "S1" | 
                                   site == "S2" ~ "Low",
                                   site == "ZP" | 
                                   site == 'ZA' | 
                                   site == "YO" | 
                                   site == "MI" ~ "Medium",
                                   site == 'SK' |
                                   site == 'SN' | 
                                   site == "AW" | 
                                   site == "G1" |
                                   site == "G2"~ "High"))

mol_class <- mol_class[,c(4,1,5:7,2:3)] #re-order columns

mol_class$pressure <- ordered(mol_class$pressure, levels=c("Low","Medium", "High"))
mol_class$site <-ordered(mol_class$site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))
mol_class[,2:4] <- lapply(mol_class[,2:4], as.factor)
mol_class[,6:7] <- lapply(mol_class[,6:7], as.numeric)

str(mol_class)
```

# Mollusks | Abundance by class by depth within site

## Create the input dataframe

Adjust `mol_class` to create a new input data frame for the bar plot.
Include a column with - mean echinoderm abundance by class per depth
within site among replicates; - standard deviation by class per depth
within site among replicates.

Standard deviation will be used to add error bars to the bar plot.

```{r message=FALSE, warning=FALSE}
mol_mean <- mol_class %>% 
  group_by(site_depth,site,depth,pressure) %>%
  reframe(Biv_mean=round(mean(Bivalvia),0),
            Gas_mean=round(mean(Gastropoda),0),
            Biv_sd=round(sd(Bivalvia),0),
            Gas_sd=round(sd(Gastropoda),0))
```

https://seananderson.ca/2013/10/19/reshape/

```{r}
library(reshape2)
mol_mean_long <- melt(mol_mean[,1:6], id.vars = c("site_depth","site","depth","pressure"),
  variable.name = "class", 
  value.name = c("mean"))

mol_sd_long <- melt(mol_mean[,c("site_depth","Biv_sd","Gas_sd")], id.vars = c("site_depth"),
  variable.name = "class", 
  value.name = c("sd"))

mol_mean_bar <- cbind(mol_mean_long,mol_sd_long$sd)
mol_mean_bar

mol_mean_bar <- mol_mean_bar %>% 
  mutate(class = case_when(class == 'Biv_mean' ~ "Bivalvia", 
                           class == "Gas_mean"~ "Gastropoda")) %>% #replace class values with class names
  rename(sd = `mol_sd_long$sd`) #rename sd column


mol_mean_bar$phylum <- "Mollusca" # add the phylum column
mol_mean_bar$phylum <- as.factor(mol_mean_bar$phylum ) # 
mol_mean_bar <- mol_mean_bar[,c(1:4,8,5:7)] #re-order columns

rm(mol_mean_long, mol_sd_long)
```

# Echinoderms | Abundance estimates

Merge raw files from each site in a single data frame

```{r}
ech_raw <-  list.files(path = here("Multi-taxa_data","MollEchino","Ech_raw"),
             pattern = "*.xlsx",
             full.names =T) %>%  
  lapply(read_excel) %>% 
  bind_rows
```

Format the data frame for analysis 

```{r}
ech_raw$CLASS <- replace(ech_raw$CLASS,ech_raw$CLASS=="-",NA)
ech_raw[,c(1:4,7)] <- lapply(ech_raw[,c(1:4,7)], as.factor)
ech_raw$site <-ordered(ech_raw$site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))
str(ech_raw)

levels(ech_raw$CLASS)
```

Extract abundance by class per transect (replicate) from the dataframe

```{r}
library(tidyr) #to use the "separate" function
library(janitor) #to use the tabyl function

ech_raw <- ech_raw[!is.na(ech_raw$transect),]

ech_class <- ech_raw[!is.na(ech_raw$CLASS),] %>% 
  tabyl(transect, CLASS, show_missing_levels = FALSE)

ech_class <- ech_class %>% 
  separate(transect, c("site", "depth_rep")) %>% 
  mutate(transect = ech_class$transect )

ech_class$depth <- gsub("[[:digit:]]", "", ech_class$depth_rep) #remove the number from depth

# Remove Numbers from Alphanumeric Character String Using gsub() Function
ech_class <- ech_class %>% 
  mutate(site_depth = paste(site, depth, sep='_')) %>%
  dplyr::select(-depth_rep) #remove depth_rep
```

Add pressure score column 

```{r}
ech_class <- ech_class %>% 
       mutate(pressure = case_when(site == 'HI' | 
                                   site == "S1" | 
                                   site == "S2" ~ "Low",
                                   site == "ZP" |
                                   site == 'ZA' | 
                                   site == "YO" | 
                                   site == "MI" ~ "Medium",
                                   site == 'SK' |
                                   site == 'SN' | 
                                   site == "AW" | 
                                   site == "G1" |
                                   site == "G2"~ "High"))

ech_class <- ech_class[,c(7,1,8:10,2:6)]  #re-ordering the column
ech_class$pressure <- ordered(ech_class$pressure, levels=c("Low","Medium", "High"))

ech_class$site <-ordered(ech_class$site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))

ech_class[,3:5] <- lapply(ech_class[,3:5], as.factor)

str(ech_class)
```

# Echinoderms | Abundance by class by depth within site

## Create the input dataframe

Adjust `ech_class` to create a new input dataframe for the barplot.
Include a column with - mean echinoderm abundance by class per depth
within site among replicates; - standard deviation by class per depth
within site among replicates.

Standard deviation will be used to add error bars to the barplot.

```{r}
ech_mean <- ech_class %>%
  group_by(site_depth,site,depth,pressure) %>% 
  reframe(Ast_mean=round(mean(Asteroidea),0),
            Cri_mean=round(mean(Crinoidea),0),
            Ech_mean=round(mean(Echinoidea),0),
            Hol_mean=round(mean(Holothuroidea),0),
            Oph_mean=round(mean(Ophiuroidea),0),
            Ast_sd=round(sd(Asteroidea),0),
            Cri_sd=round(sd(Crinoidea),0),
            Ech_sd=round(sd(Echinoidea),0),
            Hol_sd=round(sd(Holothuroidea),0),
            Oph_sd=round(sd(Ophiuroidea),0),)
```

https://seananderson.ca/2013/10/19/reshape/

```{r}
library(reshape2)
ech_mean_long <- melt(ech_mean[,1:9], id.vars = c("site_depth","site","depth","pressure"),
  variable.name = "class", 
  value.name = c("mean"))

ech_sd_long <- melt(ech_mean[,c(1,10:14)], id.vars = c("site_depth"),
  variable.name = "class", 
  value.name = c("sd"))


ech_mean_bar <- cbind(ech_mean_long,ech_sd_long$sd)
ech_mean_bar

ech_mean_bar <- ech_mean_bar %>% 
  mutate(class = case_when(class == 'Ast_mean' ~ "Asteroidea", 
                           class == "Cri_mean"~ "Crinoidea",
                           class == 'Ech_mean' ~ "Echinoidea", 
                           class == "Hol_mean"~ "Holothuroidea",
                           class == 'Oph_mean' ~ "Ophiuroidea")) %>% #replace class values with class names
  rename(sd = `ech_sd_long$sd`) #rename sd column

ech_mean_bar$phylum <- "Echinodermata" # add the phylum column
ech_mean_bar$phylum <- as.factor(ech_mean_bar$phylum ) 

ech_mean_bar <- ech_mean_bar[,c(1:4,8,5:7)] #re-order columns

rm(ech_mean_long, ech_sd_long)
```

# Invertebrates 

## Barplot with mollusk and echinoderm abundance by class by depth within site

```{r}
inv_bar <- rbind(mol_mean_bar,ech_mean_bar)
str(inv_bar)

inv_bar$class <- ordered(inv_bar$class,levels=c("Bivalvia", "Gastropoda","Asteroidea","Crinoidea","Echinoidea","Holothuroidea","Ophiuroidea"))

invPalette <- c("#56B4E9","#0072B2","#F0E442","#E69F00","#D55E00","#CC79A7","orchid3")
```

Ophiuroidea were removed from the plot because they were recorded only at one site

- scale= "free" --> https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2

- switch --> https://stackoverflow.com/questions/3261597/change-the-position-of-the-strip-label-in-ggplot-from-the-top-to-the-bottom#:~:text=As%20of%20ggplot2%202.0%2C%20the,be%20displayed%20to%20the%20left.

- strip.placement --> https://stackoverflow.com/questions/3261597/change-the-position-of-the-strip-label-in-ggplot-from-the-top-to-the-bottom#:~:text=As%20of%20ggplot2%202.0%2C%20the,be%20displayed%20to%20the%20left.

```{r}
ggplot(subset(inv_bar, inv_bar$class != "Ophiuroidea"),
       aes(x=depth, y=mean, fill=class, label=mean, color=phylum)) +
  geom_bar(aes(alpha=depth),position="dodge",stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=.2,
                 position="dodge")+
  facet_grid(site ~ class, scales = "free", switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within site",
       y="Mean abundance by class")+
  scale_fill_manual(values=invPalette)+
  scale_color_manual(values=c("blue","firebrick"), guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.x = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")+ 
  coord_flip()
```

Export plot

```{r, eval = F}
ggsave("mol-ech_abundance_vert_barplot.tiff", 
       units="in", width=7, height=6, dpi=300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

Vertical box plot

```{r}
ggplot(subset(inv_bar, inv_bar$class != "Ophiuroidea"),
       aes(x=depth, y=mean, fill=class, label=mean, color=phylum)) +
  geom_bar(aes(alpha=depth),position="dodge",stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=.2,
                 position="dodge")+
  facet_grid(class ~ site, scales = "free", switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within site",
       y="Mean abundance by class")+
  scale_fill_manual(values=invPalette)+
  scale_color_manual(values=c("blue","firebrick"), guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")
```

Export plot

```{r, eval= F}
ggsave("mol-ech_abundance_barplot.tiff", 
       units = "in", width = 7, height = 6, dpi = 300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))
```


## Barplot with mollusk and echinoderm abundance by class by depth within pressure exposure

```{r}
ech_mean_pressure <- ech_class %>%
  group_by(depth,pressure) %>% 
  reframe(Ast_mean=round(mean(Asteroidea),0),
            Cri_mean=round(mean(Crinoidea),0),
            Ech_mean=round(mean(Echinoidea),0),
            Hol_mean=round(mean(Holothuroidea),0),
            Oph_mean=round(mean(Ophiuroidea),0),
            Ast_sd=round(sd(Asteroidea),0),
            Cri_sd=round(sd(Crinoidea),0),
            Ech_sd=round(sd(Echinoidea),0),
            Hol_sd=round(sd(Holothuroidea),0),
            Oph_sd=round(sd(Ophiuroidea),0),)
```

https://seananderson.ca/2013/10/19/reshape/

```{r}
library(reshape2)
ech_mean_long_pressure <- melt(ech_mean_pressure[,1:7],
                               id.vars = c("pressure","depth"),
                               variable.name = "class", 
                               value.name = c("mean"))

ech_sd_long_pressure <- melt(ech_mean_pressure[,c(1,2,8:12)],
                             id.vars = c("pressure","depth"),
                             variable.name = "class",
                             value.name = c("sd"))           


ech_mean_bar_pressure <-cbind(ech_mean_long_pressure,
                              ech_sd_long_pressure$sd)

ech_mean_bar_pressure <- ech_mean_bar_pressure %>% 
  mutate(class = case_when(class == 'Ast_mean' ~ "Asteroidea", 
                           class == "Cri_mean"~ "Crinoidea",
                           class == 'Ech_mean' ~ "Echinoidea", 
                           class == "Hol_mean"~ "Holothuroidea",
                           class == 'Oph_mean' ~ "Ophiuroidea")) %>% #replace class values with class names
  rename(sd = `ech_sd_long_pressure$sd`) #rename sd column

ech_mean_bar_pressure$phylum <- "Echinodermata" # add the phylum column
ech_mean_bar_pressure$phylum <- as.factor(ech_mean_bar_pressure$phylum ) 

ech_mean_bar_pressure <- ech_mean_bar_pressure[,c(6,3,1,2,4,5)] #re-order columns

rm(ech_mean_long_pressure, ech_sd_long_pressure)
```


```{r message=FALSE, warning=FALSE}
mol_mean_pressure <- mol_class %>% 
  group_by(pressure, depth) %>%
  reframe(Biv_mean=round(mean(Bivalvia),0),
            Gas_mean=round(mean(Gastropoda),0),
            Biv_sd=round(sd(Bivalvia),0),
            Gas_sd=round(sd(Gastropoda),0))
```

https://seananderson.ca/2013/10/19/reshape/

```{r}
library(reshape2)
mol_mean_long_pressure <- melt(
  mol_mean_pressure[,c("depth","pressure","Biv_mean","Gas_mean")],
  id.vars = c("pressure","depth"),
  variable.name = "class",
  value.name = c("mean"))

mol_sd_long_pressure <- melt(
  mol_mean_pressure[,c("depth","pressure","Biv_sd","Gas_sd")],
  id.vars = c("pressure","depth"),
  variable.name = "class", 
  value.name = c("sd"))

mol_mean_bar_pressure <- cbind(mol_mean_long_pressure,mol_sd_long_pressure$sd)
mol_mean_bar_pressure

mol_mean_bar_pressure <- mol_mean_bar_pressure %>% 
  mutate(class = case_when(class == 'Biv_mean' ~ "Bivalvia", 
                           class == "Gas_mean"~ "Gastropoda")) %>% #replace class values with class names
  rename(sd = `mol_sd_long_pressure$sd`) #rename sd column


mol_mean_bar_pressure$phylum <- "Mollusca" # add the phylum column
mol_mean_bar_pressure$phylum <- as.factor(mol_mean_bar_pressure$phylum ) # 
mol_mean_bar_pressure <- mol_mean_bar_pressure[,c(6,3,1,2,4,5)] #re-order columns

rm(mol_mean_long_pressure, mol_sd_long_pressure,mol_mean_pressure)
```

Merge 

```{r}
inv_bar_pressure <- rbind(mol_mean_bar_pressure,ech_mean_bar_pressure)

str(inv_bar_pressure)

inv_bar_pressure$class <- 
  ordered(inv_bar_pressure$class,
          levels=c("Bivalvia", "Gastropoda","Asteroidea","Crinoidea","Echinoidea","Holothuroidea","Ophiuroidea"))
```
BAR PLOT PER PRESSURE

```{r}
ggplot(subset(inv_bar_pressure, inv_bar_pressure$class != "Ophiuroidea"),
       aes(x=depth, y=mean, fill=class, label=mean, color=phylum)) +
  geom_bar(aes(alpha=depth),position="dodge",stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=.2,
                 position="dodge")+
  facet_grid(class ~ pressure, scales = "free", switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within site",
       y="Mean abundance by class")+
  scale_fill_manual(values=invPalette)+
  scale_color_manual(values=c("blue","firebrick"), guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.x = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")+
    coord_flip()

ggplot(subset(inv_bar_pressure, inv_bar_pressure$class != "Ophiuroidea"),
       aes(x=depth, y=mean, fill=class, label=mean, color=phylum)) +
  geom_bar(aes(alpha=depth),position="dodge",stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=.2,
                 position="dodge")+
  facet_grid(class ~ pressure, scales = "free", switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within pressure levels",
       y="Mean abundance by class")+
  scale_fill_manual(values=invPalette)+
  scale_color_manual(values=c("blue","firebrick"), guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")
```

Export plot

```{r, eval= F}
ggsave("mol-ech_abundance_pressure_barplot.tiff", 
       units = "in", width = 4, height = 6, dpi = 300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

Plot filled w/ colors by pressure

```{r}
ggplot(subset(inv_bar_pressure, inv_bar_pressure$class != "Ophiuroidea"),
       aes(x=depth, y=mean, fill=pressure, label=mean, color=pressure)) +
  geom_bar(aes(alpha=depth),position="dodge",stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), width=.2,
                 position="dodge")+
  facet_grid(class ~ pressure, scales = "free", switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within pressure levels",
       y="Mean abundance by class")+
  scale_fill_manual(values= c(Low= rgb(0.57, 0.82, 0.31), Medium = "chocolate", High = "#9F1111"))+
  scale_color_manual(values= c(Low= rgb(0.57, 0.82, 0.31), Medium = "chocolate", High = "#9F1111"),  guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")
```

```{r}
ggplot(subset(inv_bar_pressure, inv_bar_pressure$class != "Ophiuroidea"),
       aes(x=depth, y=mean, 
           fill=pressure, 
           label=mean, 
           color=pressure)) +
  geom_bar(aes(alpha=depth), 
           position="dodge",
           stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), 
                width=.2,
                position="dodge")+
  facet_grid(class ~ pressure, 
             scales = "free", 
             switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within pressure levels",
       y="Mean abundance by class")+
  scale_x_discrete(labels = c("Deep", "Shallow"))+
  scale_fill_manual(values= c(Low= rgb(0.6, 0.8, 0.6), 
                              Medium = rgb(1, 0.85, 0.4),
                              High = rgb(1,0.6,0.6)
                              )
                    )+
  scale_color_manual(values= c(Low= rgb(0.2, 0.3, 0.4), 
                               Medium = rgb(0.99, 0.65, 0.04),  
                               High = "#9F1111"),  
                     guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")
```

```{r}
ggplot(subset(inv_bar_pressure, inv_bar_pressure$class != "Ophiuroidea"),
       aes(x=depth, y=mean, 
           fill=pressure, 
           label=mean, 
           color=pressure)) +
  geom_bar(aes(alpha=depth), 
           position="dodge",
           stat="identity") +
  geom_errorbar(aes(ymin=mean, ymax=mean+sd), 
                width=.2,
                position="dodge")+
  facet_grid(class ~ pressure, 
             scales = "free", 
             switch = "y")+ # https://stackoverflow.com/questions/18046051/setting-individual-axis-limits-with-facet-wrap-and-scales-free-in-ggplot2
  theme_classic()+
  labs(x="Depth within pressure levels",
       y="Mean abundance by class (# individuals)")+
  scale_x_discrete(labels = c("Deep", "Shallow"))+
  scale_fill_manual(values= c(Low= rgb(0.6, 0.8, 0.6), 
                              Medium = rgb(1, 0.85, 0.4),
                              High = rgb(1,0.6,0.6)
                              )
                    )+
  scale_color_manual(values= c(Low= rgb(0.2, 0.3, 0.4), 
                               Medium = rgb(0.99, 0.65, 0.04),  
                               High = "#9F1111"),  
                     guide ="none")+
  scale_alpha_manual(values=c(1,.6))+
  guides(fill="none", alpha= "none")+
  theme(axis.text = element_text(size = 10),
        panel.grid.major.y = element_line(color = "grey",
                                          size = 0.5,
                                          linetype = 2),
        strip.placement = "outside")
```

Export plot for poster

```{r, eval= F}
ggsave("mol-ech_abundance_pressure_barplot_poster.tiff", 
       units = "in", width = 4, height = 6, dpi = 300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))

ggsave("mol-ech_abundance_pressure_barplot_poster.png", 
       units = "in", width = 4, height = 6, dpi = 300,
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

## Export clean data

```{r, eval =F}
#export each data frame to separate sheets in same Excel file
openxlsx::write.xlsx(list("inv_bar" = inv_bar,
                          "inv_bar_pressure" = inv_bar_pressure),
                     file = here("Multi-taxa_data","MollEchino","Output",
                   "inv_clean.xlsx")) 
```
Remove objects

```{r}
rm(ech_raw, ech_mean, ech_mean_bar, ech_mean_bar_pressure, ech_mean_pressure,
   mol_raw_df, mol_mean, mol_mean_bar, mol_mean_bar_pressure)
```


# nMDS

Load packages

```{r}
library(vegan)
library(MASS)
```

## Format the data

```{r}
str(mol_class)
str(ech_class)

# missing transects in mol_class:"AW_S3", "G1_D3","S2_D1" 
# missing transects in ech_class: "MI_S2", "MI_S3", "S1_S2", "S1_S3","ZP_D1","ZP_D2","ZP_D3","ZP_S2","ZP_S3"

inv_df <- merge(mol_class, ech_class,
                by=c("transect","site","depth","site_depth","pressure"), 
                all = T)

inv_mat <- inv_df[,-c(1:5)]
inv_mat <- as.data.frame(lapply(inv_mat[,c(1:7)], as.numeric))

str(inv_mat)
inv_mat[is.na(inv_mat)] <- 0

for (i in 1:7) { 
  inv_mat[,i] <- log1p(inv_mat[,i]) #apply the transformation log10(x+1) to avoid -inf values
}

str(inv_mat)

inv_mat <- as.matrix(inv_mat) #convert to matrix
rownames(inv_mat) <- inv_df$transect

#Create a df with independent variables
ind_df <- inv_df[,c(1:5)]

```
## Format and export data for Primer

```{r}
inv_mat_primer <- data.frame(t(inv_mat))
inv_mat_primer$Class <- colnames(inv_mat)
inv_mat_primer <- inv_mat_primer[,c(70,1:69)]
```

```{r}
ind_df_primer <- ind_df %>%
  mutate(pressure_depth = paste(pressure, depth, sep='_'))

ind_df_primer <- ind_df_primer[,c(5,2:4,6)] # remove transect column
ind_df_primer <- data.frame(t(ind_df_primer))
ind_df_rownames <- rownames(ind_df_primer)
ind_df_primer$Factor <- ind_df_rownames
ind_df_primer <- ind_df_primer[,c(70,1:69)]
rm(ind_df_rownames)
```


## Export data for primer

```{r, eval =F}
#export each data frame to separate sheets in same Excel file
openxlsx::write.xlsx(list("inv_mat_primer" = inv_mat_primer,
                          "ind_df_primer" = ind_df_primer),
                     file = here("Multi-taxa_data","MollEchino","Output",
                   "inv_primer.xlsx")) 
```

## Run the Nonmetric Multidimensional scaling

```{r}
##metaMDS (isoMDS with random start, reduced  stress)----
set.seed(69) #random number to start
inv_nmds_br=metaMDS(inv_mat,distance = "bray",k=2) #Bray-Curtis resemblance matrix;k=2 means 2 dimensional
```

## Evaluate the nMDS mapping based on the stress and goodness of fit

```{r}
stressplot(inv_nmds_br) #evaluating NMDS mapping: stressplot
inv_nmds_br_gof=goodness(inv_nmds_br) #evaluating NMDS mapping: goodness of fit
inv_nmds_br_gof #smaller the value, the lower stress and better fit
plot(inv_nmds_br, type="t", main="goodness of fit") # create a plot for goodness of fit visualization:
points(inv_nmds_br, display="site", cex=inv_nmds_br_gof*100) #display the goodness of fit on the plot
#Stress lesser, better (>0.2 poor,0.2-0.1 moderate,0.1-0.05 good,<0.05 excellent); 
#K level higher, stress lesser
str(inv_nmds_br)
```

Stress = `r inv_nmds_br$stress` \< 0.2

Check Stress for each additional dimension

```{r}
k_vec=1:10
stress=numeric(length(k_vec))
inv_dij=metaMDSdist(inv_mat, trace=FALSE)
set.seed(69)
for(i in seq_along(k_vec)) {
  inv_nmds_br_loop=metaMDSiter(inv_dij, k=i, trace=FALSE)
  stress[i]=inv_nmds_br_loop$stress
}
plot(k_vec,stress,type="b",ylab="Stress",xlab="Dimensions") #select the K correspondent to the most drastic drop in stress
```

## nMDS visualization of nMDS plot with `ggplot()`

N.B. Visualisation with ggplot()\` first require the creation of an
input dataframe with nMDS scores

```{r}
inv_ndms_scores <- as.data.frame(scores(inv_nmds_br)$sites)  #Using the scores function from vegan to extract the site scores and convert to a data.frame
inv_ndms_scores$transect <- rownames(inv_ndms_scores) # create a column of transect names
inv_ndms_scores$site <- ind_df$site
inv_ndms_scores$depth <- ind_df$depth  #  add the grp variable created earlier
str(inv_ndms_scores)  #look at the data


NMDS1 <- inv_nmds_br$points[,1] ##also found using: > scores(faMDS)
NMDS2 <- inv_nmds_br$points[,2]
nmds_df<-cbind(ind_df, NMDS1, NMDS2)

```

nMDS plot with `ggplot()` with stress value

```{r}
inv_ndms_ggplot<-ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=site, shape=depth),size=2.5)+##separates overlapping points
  stat_ellipse(geom="polygon",
               aes(fill=pressure), alpha=.2,type='t',size =1)+ ##draws 95% confidence interval ellipses
  theme_classic()+
  annotate("text", x=-0.9, y=-0.85, 
           label=paste('Stress =',round(inv_nmds_br$stress,3))) #add stress to plot

inv_ndms_ggplot
```

## nMDS plot with `geom_mark_ellipse()` from `ggforce`

```{r}
#install.packages("ggforce")
library(ggforce)

inv_ndms_ggplot <- ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=site, shape=depth),size=3)+##separates overlapping points
  geom_mark_ellipse(aes(fill=pressure), expand = 0)+ # https://luisdva.github.io/rstats/Grouping-points/
  theme_classic()+
  ggtitle("nMDS of mollusks and echinoderm abundance")+
  theme(legend.position = "right",
        plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  guides(color = guide_legend(order = 1,title="Site"),
         fill = guide_legend(order = 1,title="Pressure"),
         shape = guide_legend(order = 2,title="Depth",))+
  scale_shape_manual(labels = c("Deep", "Shallow"),values = c(16,17))+
  scale_x_continuous(limits = c(-1.2,1))+
  scale_y_continuous(limits = c(-1.2,1))+
  annotate("text", x=-1.20, y=0.97, 
           label=bquote(atop('Non-metric fit,'~ R^2~"= 0.968",
                             Stress == .(round(inv_nmds_br$stress,3)),
                             )),
           size=3, hjust=0)

inv_ndms_ggplot
```

```{r}
pal12 <- c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d")

ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=site, shape=depth),
             size=2.5)+##separates overlapping points
  guides(color = guide_legend(order=1, title = "Site", ncol =2),
         shape = guide_legend(order=2, title = "Depth"))+
  scale_shape_manual(labels = c("Deep", "Shallow"),values = c(16,17))+
  ggnewscale::new_scale_color() +
  geom_mark_ellipse(aes(fill=pressure, color=pressure), expand = 0, alpha=0.2)+ # https://luisdva.github.io/rstats/Grouping-points/
  scale_color_manual(values= c("#009F81", "#FFB331","#9F1111"),
                      aesthetics = c("colour", "fill"),
                     guide = guide_legend(title = "Pressure"))+
  theme_classic()+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  scale_x_continuous(limits = c(-1.2,1))+
  scale_y_continuous(limits = c(-1.2,1.15))+
  annotate("text", x=-1.20, y=0.97, 
           label=bquote(atop('Non-metric fit,'~ R^2~"= 0.968",
                             Stress == .(round(inv_nmds_br$stress,3)),
                             )),
           size=3, hjust=0) #add goodness of fit to plot
```

```{r}
ggplot(nmds_df, aes(NMDS1, NMDS2))+
  stat_ellipse(geom= "polygon",aes(fill=pressure), alpha=0.3)+
  scale_color_manual(values= c("#009F81", "#FFB331","#9F1111"),
                      aesthetics = c("fill"),
                     guide = guide_legend(title = "Pressure"))+
  ggnewscale::new_scale_color() +
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=site, shape=depth),
             size=2.5)+##separates overlapping points
  guides(color = guide_legend(order=1, title = "Site", ncol =2),
         shape = guide_legend(order=2, title = "Depth"))+
  scale_shape_manual(labels = c("Deep", "Shallow"),values = c(16,17))+
  theme_classic()+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  scale_x_continuous(limits = c(-1.2,1))+
  scale_y_continuous(limits = c(-1.2,1.15))+
  annotate("text", x=-1.20, y=0.97, 
           label=bquote(atop('Non-metric fit,'~ R^2~"= 0.968",
                             Stress == .(round(inv_nmds_br$stress,3)),
                             )),
           size=3, hjust=0) #add goodness of fit to plot
```

```{r}

nmds_df <- nmds_df %>% rename(Pressure = pressure,
                              Depth= depth)

pal_fabian <- c("#8400CD","#00C2F9","#FFB2FD","#009F81","#FFC33B","#FF6E3A","#008DF9","#A40122","#E20134","#9F0162","#FF5AAF","#00FCCF")

ggplot(nmds_df, aes(NMDS1, NMDS2))+
  stat_ellipse(geom = "polygon", aes(fill = Pressure), alpha = 0.2) +
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=site, shape=Depth),size=2.5, alpha = 0.8)+##separates overlapping points+
  scale_fill_manual(values= c("#009F81", "#FFB331","#9F1111"))+
  scale_color_manual(values= pal_fabian)+
  labs(x = "NMDS1", colour = "Site", y = "NMDS2") +
  guides(color= guide_legend(order=1, title = "Site", ncol =2))+
  theme_classic()+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
    annotate("text", x=Inf, y=-Inf, hjust = 2.8, vjust = -11,
           label=bquote(atop(Stress == .(round(inv_nmds_br$stress,3)),
                             'Non-metric fit,'~ R^2~"= 0.993")),
           size=3) #add goodness of fit to plot
```


```{r, eval= F}
ggsave("inv_ndms_ggplot.tiff", 
       units="in", width=6, height=5, dpi=300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))

ggsave("inv_ndms_ggplot.png", 
       units="in", width=6, height=5, dpi=300,
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

# MANTEL TEST

```{r load libraries for Mantel test}
library(fields)
library(reshape2)
library(ade4)
library(adespatial)
library(spdep)
library(ggplot2)
```

Load distance file and create distance matrix 
```{r load distance file}
Ok_dist_69 <- read.csv(file=here("Multi-taxa_data","Ok_dist_69.csv"), row.names=1 )
head(Ok_dist_69)
Dist_km <- as.dist(rdist.earth(Ok_dist_69, miles=F))

inv_bray <- vegdist(inv_mat, method = "bray")
```


Correlation between straight-line geographic distance and dissimilarity in species composition

```{r}
set.seed(69)
mantel(Dist_km, inv_bray)
```

Plot
```{r}
inv_matrix_dist <- data.frame(x = melt(as.matrix(Dist_km))$value, 
                          y = melt(as.matrix(inv_bray))$value) ## Prepare data for graphic

ggplot(inv_matrix_dist) +
  geom_jitter( aes(x,y), shape = 21, size = 3, fill = "#8fc7a0") +
  labs(x = "Distance (km)", 
       y = "Dissimilarity (Bray-Curtis)") +
  geom_smooth( aes(x,y), method = "glm") +
  theme_classic()
```
```{r, eval=F}
ggsave("inv_dissimil_distance.tiff", 
       units="in", width=6, height=4, dpi=300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))

ggsave("inv_dissimil_distance.png", 
       units="in", width=6, height=4, dpi=300,
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

Mantel 
```{r}
set.seed(69)
mantel_inv <- mantel.randtest(inv_bray, Dist_km)
mantel_inv
```

# Boxplot of within-site distance from centroid visualization with `ggplot()`

Create an input dataframe for the boxplot with mean relative cover by
category and depth within site

```{r}
inv_dist = vegdist(inv_mat, 
                   method="bray")
set.seed(69)
inv_bd_site = betadisper(inv_dist, 
                    ind_df$site)  #Implements Marti Anderson's PERMDISP2 procedure for the analysis of multivariate homogeneity of group dispersions (variances). betadisper is a multivariate analogue of Levene's test for homogeneity of variances 
str(inv_bd_site)

inv_bd_site$distances #Extract betadisper scores

distcent_df <- data.frame(Distance_to_centroid=inv_bd_site$distances,Sites=ind_df$site, Pressure=ind_df$pressure) 
Sites <- inv_bd_site$group
distcent_df[,2]<-factor(distcent_df[,2],levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))
distcent_df[,3]<-factor(distcent_df[,3],levels=c("Low","Medium","High"))

distcent_mean_df <- distcent_df %>%
  group_by(Sites) %>% 
  summarise(`Mean distance to centroid`=round(mean(Distance_to_centroid),2),
         SD=round(mean(Distance_to_centroid),2)) %>%
  mutate(Pressure = case_when(Sites == 'HI' | 
                              Sites == "S1" | 
                              Sites == "S2" ~ "Low", 
                              Sites == "ZP" |
                              Sites == 'ZA' | 
                              Sites == "YO" | 
                              Sites == "MI" ~ "Medium",
                              Sites == 'SK' |
                              Sites == 'SN' | 
                              Sites == "AW" | 
                              Sites == "G1" |
                              Sites == "G2"~ "High"))
  
distcent_mean_df <- distcent_mean_df[,c(1,4,2,3)]
```

Boxplot with `geom_boxplot` from `ggplot2`

```{r}
inv_box <- ggplot(data=distcent_df,aes(x=Sites,y=Distance_to_centroid))+ 
  geom_boxplot(aes(fill=Pressure,colour=Pressure),alpha=0.3)+
  geom_jitter(aes(fill=Pressure,color=Pressure),alpha=0.7)+
  scale_fill_manual(values= c("#009F81", "#FFB331","#9F1111"))+
  scale_color_manual(values= c("#009F81","#FFB331","#9F1111"))+
  theme_classic()+
  labs(title="Boxplot of mean distance to centroid by site")+
  ylab(label="Distance to centroid")+
  theme(legend.position = "none", #remove legend
        plot.title  = element_text(hjust = 0.5, face= "bold", size =14),
        axis.text=element_text(size=14))

inv_box

ggpubr:: ggarrange(inv_box, 
                   gridExtra::tableGrob(distcent_mean_df), 
                   ncol = 2, widths = c(1,1))
```

```{r}
inv_box <- ggplot(data=distcent_df,aes(x=Sites,y=Distance_to_centroid))+ 
  geom_boxplot(aes(fill=Pressure,colour=Pressure),alpha=0.3)+
  geom_jitter(aes(fill=Pressure,color=Pressure),alpha=0.7)+
  scale_fill_manual(values= c("#009F81", "#FFB331","#9F1111"))+
  scale_color_manual(values= c("#009F81","#FFB331","#9F1111"))+
  theme_classic()+
  ylab(label="Distance to centroid")+
  theme(legend.position = "none", #remove legend
        plot.title  = element_text(hjust = 0.5, face= "bold", size =14),
        axis.text=element_text(size=14))

inv_box

ggpubr:: ggarrange(inv_box, 
                   gridExtra::tableGrob(distcent_mean_df), 
                   ncol = 2, widths = c(1,1))
```

```{r, eval=F}
ggsave("inv_distcent_boxplot.tiff", 
       units="in", width=12, height=4, dpi=300, compression = 'lzw',
       path = here ("Multi-taxa_data","MollEchino","Output"))

ggsave("inv_distcent_boxplot.png", 
       units="in", width=12, height=4, dpi=300,
       path = here ("Multi-taxa_data","MollEchino","Output"))
```

# SIMPER: Similarity of percentage

From the vignette: *The simper functions performs pairwise comparisons
of groups of sampling units and finds the contribution of each species
to the average between-group Bray-Curtis dissimilarity. Although the
method is called simper, it really studied dissimilarities instead of
similarities (Clarke 1993).*

## SIMPER PER SITE:

```{r}
inv_sim=simper(inv_mat,
               group=ind_df$site,
               permutations = 9999) #Distinguish categories which caused the differences in relative cover among sites
inv_sim
summary(inv_sim, ordered=T, digits=3) #check which categories were the main driver of difference among sites
```

## SIMPER PER DEPTH:

```{r}
inv_sim_depth = simper(inv_mat,
                     group = ind_df$depth) #Distinguish categories which caused the differences in relative cover among sites
inv_sim_depth
summary(inv_sim_depth, ordered=T, digits=3) #check which categories were the main driver of difference among sites
```

## SIMPER per anthropogenic pressure exposure

```{r}
inv_sim_pres = simper(inv_mat, 
                    group=ind_df$pressure,
                    permutations= 9999) #Distinguish categories which caused the differences in relative cover among sites
inv_sim_pres
summary(inv_sim_pres, ordered=T, digits=3) #check which categories were the main driver of difference among sites
```

# Session info

```{r}
sessionInfo()
```

# References

```{r}
#install.packages("report")
library(report)
report(sessionInfo())
```
