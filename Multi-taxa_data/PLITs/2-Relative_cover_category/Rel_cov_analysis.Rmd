---
title: "Relative cover analysis"
author: "Claudia Campanini"
date: 
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load some basic libraries

```{r}
library(dplyr)
library(ggplot2)
library(readxl)   # to import excel datasets
library("writexl") # to export df to excel files (write_xlsx)
```
# MEAN RELATIVE BENTHIC COVERBY CATEGORY

Load input file 

```{r}
cov_df <- read_excel("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/2-Relative_cover_category/plits_ext_df.xlsx")
str(cov_df)
```
## PER SITE
Follow the link for explanation of dcast function https://seananderson.ca/2013/10/19/reshape/

```{r}
mean_rel_cov_site <- cov_df %>%
  group_by(Site, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

library(reshape2) #needed for dcast function
mean_rel_cov_site <- dcast(mean_rel_cov_site, Site ~ Category)

mean_rel_cov_site <- mean_rel_cov_site %>%
  mutate(Pressure = case_when(Site == 'HI' | 
                              Site == "S1" | 
                              Site == "S2" ~ "Low",
                              Site == "ZP" |
                              Site == 'ZA' | 
                              Site == "YO" | 
                              Site == "MI" ~ "Medium",
                              Site == 'SK' |
                              Site == 'SN' | 
                              Site == "AW" | 
                              Site == "G1" |
                              Site == "G2"~ "High"))

mean_rel_cov_site[,1]<-factor(mean_rel_cov_site[,1],levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))

mean_rel_cov_site <- mean_rel_cov_site[,c(1,11,2:10)] #re-ordering columns
mean_rel_cov_site
```
Export table with mean relative benthic cover by category per site within Depth level

```{r}
write_xlsx(mean_rel_cov_site,"C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/mean_rel_cov_site.xlsx")
```

## PER SITE WITHIN Depth

```{r}
mean_rel_cov_df <- cov_df %>%
  group_by(Site_depth, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

Site_depth <- mean_rel_cov_df$Site_depth

library(tidyr) # needed for separate_wider_delim function
mean_rel_cov_df <- mean_rel_cov_df %>%
  separate_wider_delim(Site_depth, "_", names = c("Site", "Depth")) %>%
  mutate(Site_depth=Site_depth)

rm(Site_depth)

mean_rel_cov_df <- mean_rel_cov_df %>%
  mutate(Pressure = case_when(Site == "HI" | 
                              Site == "S1" | 
                              Site == "S2" ~ "Low", 
                              Site == "ZP" |
                              Site == 'ZA' | 
                              Site == "YO" | 
                              Site == "MI" ~ "Medium",
                              Site == 'SK' |
                              Site == 'SN' | 
                              Site == "AW" | 
                              Site == "G1" |
                              Site == "G2"~ "High")) 
  
mean_rel_cov_df$Site_depth <- as.factor(mean_rel_cov_df$Site_depth)
mean_rel_cov_df$Pressure <- ordered(mean_rel_cov_df$Pressure,levels=c("Low","Medium","High"))

mean_rel_cov_wide <- dcast(mean_rel_cov_df, Site_depth + Pressure ~ Category, value.var = "Mean_rel_cov")
mean_rel_cov_wide
```

Export table with mean relative benthic cover by category per site within Depth level

```{r}
write_xlsx(mean_rel_cov_wide,"C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/mean_rel_cov_Site_depth.xlsx")
```

## STACKED BARPLOTS

Load the color-blind-friendly palette with black:

```{r}
relcovPalette <- c("#009E73","#E69F00","#D55E00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7","#000000","#999999") #I changed the order compared to the original version
```

Stacked barplot of the mean relative benthic cover

N.B. I set a conditional labelling so that only mean relative cover
values \>0.15 are shown in the plot

```{r}
mean_rel_cov_df <- mean_rel_cov_df %>%                               # Replacing values
  mutate(Depth = replace(Depth, Depth == "Deep", "D")) %>%                     # Replacing values
  mutate(Depth = replace(Depth, Depth == "Shallow", "S"))

ggplot(mean_rel_cov_df, aes(fill=Category, y=Mean_rel_cov, x=Depth, label=Mean_rel_cov)) + 
  geom_bar(position="fill", stat="identity",alpha=.8, color = "black")+
  facet_grid(~ Site)+
  theme_classic()+
  labs(x="Depth",
       y="Mean relative benthic cover",
       title= "Stacked bar chart of mean relative benthic cover \n by depth within site")+
  geom_text(aes(Depth, Mean_rel_cov, label = Mean_rel_cov*100), 
            data = subset(mean_rel_cov_df,mean_rel_cov_df$Mean_rel_cov>= .15),
            size = 2.5, position = position_fill(vjust = 0.8),color="black")+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(labels = c("algae",
                                "boulder",
                                "hard coral",
                                "other",
                                "rubble",
                                "sand",
                                "soft coral",
                                "unknown",
                                "zoantharians"), values=relcovPalette)+
  scale_y_continuous(limits = c(0, 1), 
                     breaks = c(0, 0.25, 0.50, 0.75,1),
                     labels = c(0, 25, 50, 75,100))


#ggsave("relcov_stacked.tiff", units="in", width=5, height=4, dpi=300, compression = 'lzw')
```

# nMDS

Load packages

```{r}
#VEGAN----
library(vegan)#load package
#install.packages("htmltools")
library(htmltools)
library(vegan3d)
library(MASS)
library(dplyr)
library(readxl)   # to import excel datasets
```

## Format the data

Load relative benthic cover data

```{r}
#Relative benthic cover dataframe

cov_df <- read_excel("Rel_cov_input.xlsx")
str(cov_df)

cov_df <- cov_df %>% 
  rename(Depth = depth)

cov_df <- cov_df %>%
  mutate(Pressure = case_when(Site == 'HI' | 
                              Site == "S1" | 
                              Site == "S2" ~ "Low",
                              Site == "ZP" |
                              Site == 'ZA' | 
                              Site == "YO" | 
                              Site == "MI" ~ "Medium",
                              Site == 'SK' |
                              Site == 'SN' | 
                              Site == "AW" | 
                              Site == "G1" |
                              Site == "G2"~ "High"))

cov_df <- cov_df[ ,c(1:6, 25, 7:24)]

cov_df$Site<-ordered(cov_df$Site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))

cov_df$Pressure<-ordered(cov_df$Pressure,levels=c("Low", "Medium", "High"))

cov_df[,c(1,3:6)] <- lapply(cov_df[,c(1,3:6)], as.factor)  ## as.factor() could also be used

cov_df[,8:25] <- lapply(cov_df[,8:25], as.numeric)

cov_df <- cov_df[,-c(17:25)]

str(cov_df)

#create a df with the independent variables
ind_df <- as.data.frame(cov_df[,c(1:7)])
str(ind_df)
```

Convert the database `cov_df`to a matrix

```{r}
cov_mat <- cov_df[,-c(1:7)]
rownames(cov_mat) <- cov_df$Transect
cov_mat <- as.matrix(cov_mat)
str(cov_mat)
class(cov_mat)
```

## Run the Nonmetric Multidimensional scaling

```{r}
##metaMDS (isoMDS with random start, reduced  stress)----
set.seed(69) #random number to start
cov_nmds_br=metaMDS(cov_mat,distance = "bray",k=2) #Bray-Curtis resemblance matrix;k=2 means 2 dimensional
```

## Evaluate the nMDS mapping based on the stress and goodness of fit

```{r}
stressplot(cov_nmds_br) #evaluating NMDS mapping: stressplot
cov_nmds_br_gof=goodness(cov_nmds_br) #evaluating NMDS mapping: goodness of fit
cov_nmds_br_gof #smaller the value, the lower stress and better fit
plot(cov_nmds_br, type="t", main="goodness of fit") # create a plot for goodness of fit visualization:
points(cov_nmds_br, display="site", cex=cov_nmds_br_gof*100) #display the goodness of fit on the plot
#Stress lesser, better (>0.2 poor,0.2-0.1 moderate,0.1-0.05 good,<0.05 excellent); 
#K level higher, stress lesser
cov_nmds_br$stress
```
Stress = `r cov_nmds_br$stress` \< 0.1, not excellent (<0.05), but still a good ordination

Check Stress for each additional dimension

```{r}
k_vec=1:10
stress=numeric(length(k_vec))
relcov_dij=metaMDSdist(cov_mat, trace=FALSE)
set.seed(69)
for(i in seq_along(k_vec)) {
  cov_nmds_br_loop=metaMDSiter(relcov_dij, k=i, trace=FALSE)
  stress[i]=cov_nmds_br_loop$stress
}
plot(k_vec,stress,type="b",ylab="Stress",xlab="Dimensions") #select the K correspondent to the most drastic drop in stress
rm(k_vec)
```

## Plot the nMDS with basic R function `plot()`

```{r}
cov_nmds_br=metaMDS(cov_mat) #Run NMDS
plot(cov_nmds_br, type="text") #NMDS rough plot
cov_nmds_br$stress
```

```{r, fig.show='hide'}
plot(cov_nmds_br, type="n") #empty plot for next case
```
Cols from https://stackoverflow.com/questions/65013406/how-to-generate-30-distinct-colors-that-are-color-blind-friendly 

```{r}
plot(cov_nmds_br, type="n",display="site", xlim=c(-1,1),ylim=c(-1,0.5)) #plot nMDS with reference of sites, but empty
cols =c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d") #set colour matrix
pchs=c(16,18) #choose point shape
points(cov_nmds_br,cex=1.3,lwd=2,pch=pchs[ind_df$Depth],col=cols[ind_df$Site]) #don't get why it's not working
ordiellipse(cov_nmds_br,groups=ind_df$site, kind="ehull",
            col=cols, alpha=0.5,
            lwd=1.5) #ellipsoid hull for actual points
text(1.2,-1,labels="Stress =")
text(1.45,-1,labels=round(cov_nmds_br$stress,2))
```

```{r}
plot(cov_nmds_br, type="n",display="site",
     xlim=c(-1,2),ylim=c(-0.8,1.5),
     main = "nMDS of the relative benthic cover by site") 
cols =c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d") #set colour matrix
pchs=c(16,18) #choose point shape
points(cov_nmds_br,cex=1.2,lwd=2,pch=pchs[ind_df$Depth],col=cols[ind_df$Site]) #don't get why it's not working
ordispider(cov_nmds_br,groups=ind_df$Site, label=F) #Decoration: spider link on the dots shared the same factors
ordiellipse(cov_nmds_br,groups=ind_df$Site, kind="ehull",col=cols,lwd=1.5) #ellipsoid hull for actual points
text(1.2,-1,labels="Stress =")
text(1.45,-1,labels=round(cov_nmds_br$stress,2))
legend('topright', legend=unique(ind_df$Site), 
       col=unique(c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d")), 
       pch = 16,
       title = "SITE", title.adj = 0.1) # Title


rm(pchs, cols)
```

## nMDS plot with `ggplot() and` with `geom_mark_ellipse()` from `ggforce`

Create input data frame with nMDS scores necessary for visualisation
with \`ggplot()\`

```{r}
cov_ndms_scores <- as.data.frame(scores(cov_nmds_br)$sites)  #Using the scores function from vegan to extract the site scores and convert to a data.frame
cov_ndms_scores$transect <- rownames(cov_ndms_scores) # create a column of transect names
cov_ndms_scores$site <- ind_df$Site
cov_ndms_scores$Depth <- ind_df$Depth  #  add the grp variable created earlier
str(cov_ndms_scores)  #look at the data


NMDS1 <- cov_nmds_br$points[,1] ##also found using: > scores(cov_nmds_br)
NMDS2 <- cov_nmds_br$points[,2]
nmds_df<-cbind(ind_df, NMDS1, NMDS2)
rm(NMDS1,NMDS2)
```

nMDS plot

```{r}

str(cov_nmds_br)

library(ggplot2)
#install.packages("ggforce")
library(ggforce)

cov_ndms_ggplot <- ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=Site, shape=Depth),size=3)+##separates overlapping points
  geom_mark_ellipse(aes(fill=Site, color=Site), expand = 0)+ # https://luisdva.github.io/rstats/Grouping-points/
  theme_classic()+
  ggtitle("nMDS of relative benthic cover")+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  guides(color = guide_legend(order = 1,title="Site"),
         fill = guide_legend(order = 1,title="Site"),
         shape = guide_legend(order = 2,title="Depth"))+
  annotate("text", x=-0.45, y=-0.9, 
           label=paste('Stress =',round(cov_nmds_br$stress,3)),
           size=4)+
  annotate("text", x=-0.35, y=-1,
           label=bquote('Non-metric fit,'~ R^2~"= 0.998"),
           size=4) #add goodness of fit to plot
```

nMDS with ellipses based on the pressure level

```{r}
pal12 <- c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d")

library(ggnewscale) #necessary for new_scale_color 

ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=Site, shape=Depth),size=2.5)+##separates overlapping points
  scale_color_manual(values= pal12)+
  guides(color= guide_legend(order=1, title = "Site", ncol =2))+
  new_scale_color() +
  geom_mark_ellipse(aes(fill=Pressure, color=Pressure), expand = 0, alpha=0.2)+ # https://luisdva.github.io/rstats/Grouping-points/
  scale_color_manual(values= c("green","yellow","red"))+
  scale_fill_manual(values= c("green","yellow","red"))+
  theme_classic()+
  ggtitle("nMDS of relative benthic cover")+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  scale_x_continuous(limits = c(-.8,1.8))+
  scale_y_continuous(limits = c(-.7,.9))+
  annotate("text", x=1.5, y=-0.6, 
           label=bquote(atop(Stress == .(round(cov_nmds_br$stress,3)),
                             'Non-metric fit,'~ R^2~"= 0.993")),
           size=3) #add goodness of fit to plot

rm(pal12)
```

```{r}
library(ggnewscale) #necessary for new_scale_color 

ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=Site, shape=Pressure),size=2.5)+##separates overlapping points
  guides(color= guide_legend(order=1, title = "Site", ncol =2))+
  new_scale_color() +
  geom_mark_ellipse(aes(fill=Pressure, color=Pressure), expand = 0, alpha=0.2)+ # https://luisdva.github.io/rstats/Grouping-points/
  scale_color_manual(values= c("green","yellow","red"))+
  scale_fill_manual(values= c("green","yellow","red"))+
  theme_classic()+
  ggtitle("nMDS of relative benthic cover")+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  scale_x_continuous(limits = c(-.8,1.8))+
  scale_y_continuous(limits = c(-.7,.9))+
    annotate("text", x=1.5, y=-0.6, 
           label=bquote(atop(Stress == .(round(cov_nmds_br$stress,3)),
                             'Non-metric fit,'~ R^2~"= 0.993")),
           size=3) #add goodness of fit to plot
```

Test a colorblind-friendly palette using `colorblindr` package

# PERMANOVA AND POST-HOC PAIRWISE PERMANOVA

Load libraries

```{r}
#VEGAN----
library(vegan)#load package
#install.packages("vegan3d")
library(vegan3d)
library(MASS)
library(dplyr)

#install.packages("pairwiseAdonis")
library(devtools) #to install pairwiseAdonis from GitHub
library(pairwiseAdonis)
#install.packages("Rtools")
# library(remotes) #to use install_github
# install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)

library(readxl)   # to import excel datasets
```

Load and format data

```{r}
#Relative benthic cover dataframe

cov_df <- read_excel("Rel_cov_input.xlsx")
str(cov_df)

cov_df <- cov_df %>%
  mutate(Pressure = case_when(Site == 'HI' | 
                              Site == "S1" | 
                              Site == "S2" ~ "Low",
                              Site == "ZP" |
                              Site == 'ZA' | 
                              Site == "YO" | 
                              Site == "MI" ~ "Medium",
                              Site == 'SK' |
                              Site == 'SN' | 
                              Site == "AW" | 
                              Site == "G1" |
                              Site == "G2"~ "High")) %>%
  rename(Depth = depth)

cov_df <- cov_df[ ,c(1:6, 25, 7:24)]

cov_df$Site<-ordered(cov_df$Site,levels=c("HI", "S1", "S2", "ZP", "ZA", "YO", "MI","SK", "SN", "AW", "G1", "G2"))

cov_df$Pressure<-ordered(cov_df$Pressure,levels=c("Low", "Medium", "High"))

cov_df[,c(1,3:6)] <- lapply(cov_df[,c(1,3:6)], as.factor)  ## as.factor() could also be used

cov_df[,8:25] <- lapply(cov_df[,8:25], as.numeric)

cov_df <- cov_df[,-c(17:25)]

str(cov_df)

#create a df with the independent variables
ind_df <- as.data.frame(cov_df[,c(1:7)])
str(ind_df)
```
Convert the database `cov_df`to a matrix

```{r}
cov_mat <- cov_df[,-c(1:7)]
rownames(cov_mat) <- cov_df$Transect
cov_mat <- as.matrix(cov_mat)
str(cov_mat)
class(cov_mat)
```

Create a df with explanatory (independent) variables

```{r}
ind_df <- as.data.frame(cov_df[,c(1:7)])
str(ind_df)
```

## PERMANOVA among the 12 sites

### Question 1: is there a significant difference in benthic cover among sites?

```{r}
set.seed(69) 
perm=how(nperm=999)
relcov_site_pmv=adonis2(cov_mat~Site, 
                        data=ind_df,
                        permutations =perm,
                        methods="bray")
                        
relcov_site_pmv
```

P-value `r relcov_site_pmv$Pr[1]` \< 0.05, so there is a significant
difference among sites.

### Question 2: is there a significant difference in benthic cover between depth withing sites?

```{r}
#SCRIPT WITH adonis()
set.seed(69) 
perm=how(nperm=999)
relcov_Depth_pmv <- adonis(cov_mat~Depth, 
                           data=ind_df,
                           permutations =perm,
                           strata=ind_df$Site,
                           methods="bray")
relcov_Depth_pmv$aov.tab

#ALTERNATIVE SCRIPT WITH adonis2()
set.seed(69) 
h <- how(blocks = ind_df$Site, nperm = 999)
relcov_blocks_pmv <- adonis2(cov_mat~Depth,
                             data=ind_df,
                             permutations =h,
                             methods="bray")

relcov_blocks_pmv
```

### Question 3: is there a significant difference in relative benthic cover among anthropogenic pressure level?

```{r}
set.seed(69)
perm=how(nperm=999)
relcov_pressure_pmv=adonis2(cov_mat~Pressure, 
                        data=ind_df,
                        permutations =perm,
                        methods="bray")
                        
relcov_pressure_pmv
```

### Question 4: is there a significant difference in relative benthic cover abundance among sites within pressure levels?

```{r}
#SCRIPT WITH adonis()
set.seed(69)
perm=how(nperm=999)
relcov_site_pressure_pmv <- adonis(cov_mat~Site, 
                           data=ind_df,
                           permutations =perm,
                           strata=ind_df$pressure,
                           methods="bray")
relcov_site_pressure_pmv$aov.tab

#ALTERNATIVE SCRIPT WITH adonis2()
set.seed(69)
h <- how(blocks = ind_df$Pressure, nperm = 999)
relcov_site_pressure_pmv <- adonis2(cov_mat~Site,
                             data=ind_df,
                             permutations =h,
                             methods="bray")

relcov_site_pressure_pmv
```

## Permutation test of multivariate homogeneity of groups dispersions (variances)

Theoretical explanation from Anderson, Marti, Ray N. Gorley, and Robert
K. Clarke. Permanova+ for primer: Guide to software and statisticl
methods. Primer-E Limited, 2008: *In the case of a one-way analysis, the
PERMANOVA test using permutations assumes only that the samples are
exchangeable under a true null hypothesis12. The assumption of
exchangeability is tantamount to assuming that the multivariate
observations (samples) are independent and identically distributed
(i.i.d.) under a true null hypothesis. Thus, although there are no
explicit assumptions regarding the distributions of the original
variables (they are certainly not assumed to be normally distributed),
independence and homogeneity of dispersions (in the space of the
resemblance measure) are directly implied by the permutation procedure.
Clearly, if samples have very different dispersions in different groups,
then they are not really exchangeable. Also, if the samples are
unequally correlated with one another (e.g., temporally or spatially),
then randomly shuffling them will destroy this kind of inherent
structure.*

```{r}
set.seed(69) 
densityplot(permustats(relcov_site_pmv)) #density plot of permutation results to to check if assumptions are met?

relcov_dist = vegdist(cov_mat,method="bray")

relcov_bd=betadisper(relcov_dist,ind_df$Site)  #Implements Marti Anderson's PERMDISP2 procedure for the analysis of multivariate homogeneity of group dispersions (variances). betadisper is a multivariate analogue of Levene's test for homogeneity of variances 
str(relcov_bd)

plot(relcov_bd)
boxplot(relcov_bd) #check data dispersion based on sites
anova(relcov_bd) #F-test on distribution of sites

```
### Permutest Implements a permutation-based test of multivariate homogeneity of group dispersions (variances)

```{r}
set.seed(69) 
permutest(relcov_bd) #permutative test on dispersion based on sites, if significant, PERMANOVA results may be driven by  dispersion issue
permutest(relcov_bd, pairwise=TRUE) #pairwise of dispersion test
```

From Anderson, Marti, Ray N. Gorley, and Robert K. Clarke. Permanova+
for primer: Guide to software and statistical methods. Primer-E Limited,
2008: \* If significant heterogeneity were detected by PERMDISP and
differences among groups were also detected using PERMANOVA, then the
latter could have been caused by differences in location, differences in
dispersion, or some combination of the two. \*

### Post hoc test for PERMANOVA (`pairwise.adonis`)

```{r}
set.seed(69) 
relcov_pmv_phoc_holm= pairwise.adonis(cov_mat,ind_df$Site,
                                  sim.function = "vegdist", 
                                  sim.method = "bray", 
                                  p.adjust.m = "holm", 
                                  reduce = NULL)

relcov_pmv_phoc_holm

set.seed(69) 
relcov_pmv_phoc_bonf= pairwise.adonis(cov_mat,ind_df$Site,
                                  sim.function = "vegdist", 
                                  sim.method = "bray", 
                                  p.adjust.m = "bonferroni", 
                                  reduce = NULL)

relcov_pmv_phoc_bonf 
```

I can use Bonferroni because it is more conservative and it is the
adjustment adopted for the other analyses.

N.B. `pairwise.adonis` and `pairwise.adonis2` have different syntaxes!

## Permutation test of multivariate homogeneity of groups dispersions (variances)

Theoretical explanation from Anderson, Marti, Ray N. Gorley, and Robert
K. Clarke. Permanova+ for primer: Guide to software and statisticl
methods. Primer-E Limited, 2008: *In the case of a one-way analysis, the
PERMANOVA test using permutations assumes only that the samples are
exchangeable under a true null hypothesis12. The assumption of
exchangeability is tantamount to assuming that the multivariate
observations (samples) are independent and identically distributed
(i.i.d.) under a true null hypothesis. Thus, although there are no
explicit assumptions regarding the distributions of the original
variables (they are certainly not assumed to be normally distributed),
independence and homogeneity of dispersions (in the space of the
resemblance measure) are directly implied by the permutation procedure.
Clearly, if samples have very different dispersions in different groups,
then they are not really exchangeable. Also, if the samples are
unequally correlated with one another (e.g., temporally or spatially),
then randomly shuffling them will destroy this kind of inherent
structure.*

```{r}
set.seed(69) 
densityplot(permustats(relcov_site_pmv)) #density plot of permutation results to to check if assumptions are met?

relcov_dist = vegdist(cov_mat,method="bray")

relcov_bd_pres=betadisper(relcov_dist,ind_df$Pressure)  #Implements Marti Anderson's PERMDISP2 procedure for the analysis of multivariate homogeneity of group dispersions (variances). betadisper is a multivariate analogue of Levene's test for homogeneity of variances 
str(relcov_bd_pres)

plot(relcov_bd_pres)
boxplot(relcov_bd_pres) #check data dispersion based on sites
anova(relcov_bd_pres) #F-test on distribution of sites

```

### Permutest Implements a permutation-based test of multivariate homogeneity of group dispersions (variances)

```{r}
set.seed(69) 
permutest(relcov_bd) #permutative test on dispersion based on sites, if significant, PERMANOVA results may be driven by  dispersion issue
permutest(relcov_bd, pairwise=TRUE) #pairwise of dispersion test
```

From Anderson, Marti, Ray N. Gorley, and Robert K. Clarke. Permanova+
for primer: Guide to software and statistical methods. Primer-E Limited,
2008: \* If significant heterogeneity were detected by PERMDISP and
differences among groups were also detected using PERMANOVA, then the
latter could have been caused by differences in location, differences in
dispersion, or some combination of the two. \*

### Post hoc test for PERMANOVA (`pairwise.adonis`)

```{r}
set.seed(69) 
relcov_pmv_pres_phoc_holm= pairwise.adonis(cov_mat,ind_df$Pressure,
                                  sim.function = "vegdist", 
                                  sim.method = "bray", 
                                  p.adjust.m = "holm", 
                                  reduce = NULL)

relcov_pmv_pres_phoc_holm

set.seed(69) 
relcov_pmv_pres_phoc_bonf= pairwise.adonis(cov_mat,ind_df$Pressure,
                                  sim.function = "vegdist", 
                                  sim.method = "bray", 
                                  p.adjust.m = "bonferroni", 
                                  reduce = NULL)

relcov_pmv_pres_phoc_bonf 
```


# SIMPER: Similarity of percentage

From the vignette: *The simper functions performs pairwise comparisons
of groups of sampling units and finds the contribution of each species
to the average between-group Bray-Curtis dissimilarity. Although the
method is called simper, it really studied dissimilarities instead of
similarities (Clarke 1993).*

## SIMPER per site

```{r}
relcov_sim=simper(cov_mat,group=ind_df$Site) #Distinguish categories which caused the differences in relative cover among sites
relcov_sim
str(relcov_sim)
summary(relcov_sim) #check which categories were the main driver of difference among sites
```

## SIMPER per depth
```{r}
relcov_sim_Depth=simper(cov_mat,group=ind_df$Depth) #Distinguish categories which caused the differences in relative cover among sites
relcov_sim_Depth
summary(relcov_sim_Depth, ordered=T, digits=3) #check which categories were the main driver of difference among sites
```

## SIMPER per pressure exposure
```{r}
relcov_sim_pres=simper(cov_mat,group=ind_df$Pressure) #Distinguish categories which caused the differences in relative cover among sites
relcov_sim_Depth
summary(relcov_sim_pres, ordered=T, digits=3) #check which categories were the main driver of difference among sites
```

# Session info

```{r}
sessionInfo()
```

# References

```{r}
#install.packages("report")
library(report)
report(sessionInfo())
```

