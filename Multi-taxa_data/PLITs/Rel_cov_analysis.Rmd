---
title: "Relative cover analysis"
author: "Claudia Campanini"
date: 
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load some basic libraries

```{r}
library(dplyr)
library(ggplot2)
library(readxl)   # to import excel datasets
```
# MEAN RELATIVE BENTHIC COVERBY CATEGORY

Load input file 

```{r}
cov_df <- read_excel("plits_ext_df.xlsx")
str(cov_df)
```
## PER SITE
Follow the link for explanation of dcast function https://seananderson.ca/2013/10/19/reshape/

```{r}
mean_rel_cov_site <- cov_df %>%
  group_by(Site, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

mean_rel_cov_site <- dcast(mean_rel_cov_site, Site ~ Category)
```
## PER SITE WITHIN DEPTH

```{r}
mean_rel_cov_df <- cov_df %>%
  group_by(Site_depth, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

Site_depth <- mean_rel_cov_df$Site_depth

mean_rel_cov_df <- mean_rel_cov_df %>%
  separate_wider_delim(Site_depth, "_", names = c("Site", "Depth")) %>%
  mutate(Site_depth=Site_depth)

mean_rel_cov_wide <- dcast(mean_rel_cov_df, Site_depth ~ Category)
mean_rel_cov_wide
```

## STACKED BARPLOTS

Load the color-blind-friendly palette with black:

```{r}
relcovPalette <- c("#009E73","#E69F00","#D55E00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7","#000000","#999999") #I changed the order compared to the original version
```

Stacked barplot of the mean relative benthic cover

N.B. I set a conditional labelling so that only mean relative cover
values \>0.61 are shown in the plot

```{r}
ggplot(mean_rel_cov_df, aes(fill=Category, y=Mean_rel_cov, x=Depth, label=Mean_rel_cov)) + 
  geom_bar(position="fill", stat="identity",alpha=.8, color = "black")+
  facet_grid(~ Site)+
  theme_classic()+
  labs(x="Depth",
       y="Mean relative benthic cover",
       title= "Stacked bar chart of mean relative benthic cover \n by depth within site")+
  geom_text(aes(Depth, Mean_rel_cov, label = Mean_rel_cov), 
            data = subset(mean_rel_cov_df,mean_rel_cov_df$Mean_rel_cov>= .061),
            size = 3.5, position = position_fill(vjust = 0.5),color="black")+
  theme(plot.title = element_text(hjust = 0.5))

  scale_fill_manual(labels = c("algae",
                                "boulder",
                                "hard coral",
                                "other",
                                "rubble",
                                "sand",
                                "soft coral",
                                "zoantharians"), values=relcovPalette)+


#ggsave("relcov_stacked.tiff", units="in", width=5, height=4, dpi=300, compression = 'lzw')
```

