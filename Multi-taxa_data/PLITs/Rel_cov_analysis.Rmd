---
title: "Relative cover analysis"
author: "Claudia Campanini"
date: 
output: 
  html_document: 
    toc: yes
    number_sections: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load some basic libraries

```{r}
library(dplyr)
library(ggplot2)
library(readxl)   # to import excel datasets
```
# MEAN RELATIVE BENTHIC COVERBY CATEGORY

Load input file 

```{r}
cov_df <- read_excel("plits_ext_df.xlsx")
str(cov_df)
```
## PER SITE
Follow the link for explanation of dcast function https://seananderson.ca/2013/10/19/reshape/

```{r}
mean_rel_cov_site <- cov_df %>%
  group_by(Site, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

mean_rel_cov_site <- dcast(mean_rel_cov_site, Site ~ Category)
```
## PER SITE WITHIN DEPTH

```{r}
mean_rel_cov_df <- cov_df %>%
  group_by(Site_depth, Category) %>%
  summarise(Mean_rel_cov=round(mean(Rel_cov),2))

Site_depth <- mean_rel_cov_df$Site_depth

mean_rel_cov_df <- mean_rel_cov_df %>%
  separate_wider_delim(Site_depth, "_", names = c("Site", "Depth")) %>%
  mutate(Site_depth=Site_depth)

mean_rel_cov_wide <- dcast(mean_rel_cov_df, Site_depth ~ Category)
mean_rel_cov_wide
```

## STACKED BARPLOTS

Load the color-blind-friendly palette with black:

```{r}
relcovPalette <- c("#009E73","#E69F00","#D55E00", "#56B4E9", "#F0E442", "#0072B2", "#CC79A7","#000000","#999999") #I changed the order compared to the original version
```

Stacked barplot of the mean relative benthic cover

N.B. I set a conditional labelling so that only mean relative cover
values \>0.61 are shown in the plot

```{r}
ggplot(mean_rel_cov_df, aes(fill=Category, y=Mean_rel_cov, x=Depth, label=Mean_rel_cov)) + 
  geom_bar(position="fill", stat="identity",alpha=.8, color = "black")+
  facet_grid(~ Site)+
  theme_classic()+
  labs(x="Depth",
       y="Mean relative benthic cover",
       title= "Stacked bar chart of mean relative benthic cover \n by depth within site")+
  geom_text(aes(Depth, Mean_rel_cov, label = Mean_rel_cov), 
            data = subset(mean_rel_cov_df,mean_rel_cov_df$Mean_rel_cov>= .061),
            size = 3.5, position = position_fill(vjust = 0.5),color="black")+
  theme(plot.title = element_text(hjust = 0.5))

  scale_fill_manual(labels = c("algae",
                                "boulder",
                                "hard coral",
                                "other",
                                "rubble",
                                "sand",
                                "soft coral",
                                "zoantharians"), values=relcovPalette)+


#ggsave("relcov_stacked.tiff", units="in", width=5, height=4, dpi=300, compression = 'lzw')
```

# nMDS

Load packages

```{r}
#VEGAN----
library(vegan)#load package
#install.packages("htmltools")
library(htmltools)
library(vegan3d)
library(MASS)
library(dplyr)
library(readxl)   # to import excel datasets
```

## Format the data

Load relative benthic cover data

```{r}
#Relative benthic cover dataframe

cov_df <- read_excel("Rel_cov_input.xlsx")
str(cov_df)
cov_df$Site <-ordered(cov_df$Site, levels=c("awa", "g1", "g2", "mi", "sk", "sn", "yo", "za", "zp", "hi","s1", "s2"))
str(cov_df)
levels(cov_df$Site)
cov_df[,c(1,3,4,5)] <- lapply(cov_df[,c(1,3,4,5)], as.factor)  ## as.factor() could also be used
#cov_mat[,5] <- as.factor(cov_mat$Site_Depth) alternative for the single lines


cov_df[,6:13] <- lapply(cov_df[,6:13], as.numeric)
V <- cov_df[,-c(14:21)]

str(cov_df)

library(stringr)
cov_df$Site_depth <- str_c (cov_df$Site,'_', cov_df$depth)

#create a df with the independent variables
ind_df <- as.data.frame(cov_df[,c(2,4,14)])
str(ind_df)
```

Convert the database `cov_df`to a matrix

```{r}
cov_mat <- cov_df[,-c(1:5,14)]
rownames(cov_mat) <- cov_df$Transect
cov_mat <- as.matrix(cov_mat)
str(cov_mat)
class(cov_mat)
```

## Run the Nonmetric Multidimensional scaling

```{r}
##metaMDS (isoMDS with random start, reduced  stress)----
set.seed(69) #random number to start
cov_nmds_br=metaMDS(cov_mat,distance = "bray",k=2) #Bray-Curtis resemblance matrix;k=2 means 2 dimensional
```

## Evaluate the nMDS mapping based on the stress and goodness of fit

```{r}
stressplot(cov_nmds_br) #evaluating NMDS mapping: stressplot
cov_nmds_br_gof=goodness(cov_nmds_br) #evaluating NMDS mapping: goodness of fit
cov_nmds_br_gof #smaller the value, the lower stress and better fit
plot(cov_nmds_br, type="t", main="goodness of fit") # create a plot for goodness of fit visualization:
points(cov_nmds_br, display="site", cex=cov_nmds_br_gof*100) #display the goodness of fit on the plot
#Stress lesser, better (>0.2 poor,0.2-0.1 moderate,0.1-0.05 good,<0.05 excellent); 
#K level higher, stress lesser
```
Stress = `r cov_nmds_br$stress` \< 0.2

Check Stress for each additional dimension

```{r}
k_vec=1:10
stress=numeric(length(k_vec))
relcov_dij=metaMDSdist(cov_mat, trace=FALSE)
set.seed(69)
for(i in seq_along(k_vec)) {
  cov_nmds_br_loop=metaMDSiter(relcov_dij, k=i, trace=FALSE)
  stress[i]=cov_nmds_br_loop$stress
}
plot(k_vec,stress,type="b",ylab="Stress",xlab="Dimensions") #select the K correspondent to the most drastic drop in stress
```

## Plot the nMDS with basic R function `plot()`

```{r}
cov_nmds_br=metaMDS(cov_mat) #Run NMDS
plot(cov_nmds_br, type="text") #NMDS rough plot
cov_nmds_br$stress
```

```{r, fig.show='hide'}
plot(cov_nmds_br, type="n") #empty plot for next case
```

```{r}
plot(cov_nmds_br, type="n",display="site", xlim=c(-1,1),ylim=c(-1,0.5)) #plot nMDS with reference of sites, but empty
cols =c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d") #set colour matrix
pchs=c(16,18) #choose point shape
points(cov_nmds_br,cex=1.3,lwd=2,pch=pchs[ind_df$Depth],col=cols[ind_df$Site]) #don't get why it's not working
ordiellipse(cov_nmds_br,groups=ind_df$site, kind="ehull",
            col=cols, alpha=0.5,
            lwd=1.5) #ellipsoid hull for actual points
text(1.2,-1,labels="Stress =")
text(1.45,-1,labels=round(cov_nmds_br$stress,2))
```

```{r}
plot(cov_nmds_br, type="n",display="site",
     xlim=c(-1,2),ylim=c(-0.8,1.5),
     main = "nMDS of the relative benthic cover by site") 
cols =c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d") #set colour matrix
pchs=c(16,18) #choose point shape
points(cov_nmds_br,cex=1.2,lwd=2,pch=pchs[ind_df$Depth],col=cols[ind_df$Site]) #don't get why it's not working
ordispider(cov_nmds_br,groups=ind_df$Site, label=F) #Decoration: spider link on the dots shared the same factors
ordiellipse(cov_nmds_br,groups=ind_df$Site, kind="ehull",col=cols,lwd=1.5) #ellipsoid hull for actual points
text(1.2,-1,labels="Stress =")
text(1.45,-1,labels=round(cov_nmds_br$stress,2))
legend('topright', legend=unique(ind_df$Site), 
       col=unique(c("#000000","#004949","#009292","#ffb6db",
 "#490092","#006ddb","#b66dff","#b6dbff",
 "#920000","#924900","#24ff24","#ffff6d")), 
       pch = 16,
       title = "SITE", title.adj = 0.1) # Title
```

## nMDS plot with `ggplot() and` with `geom_mark_ellipse()` from `ggforce`

Create input data frame with nMDS scores necessary for visualisation
with \`ggplot()\`

```{r}
cov_ndms_scores <- as.data.frame(scores(cov_nmds_br)$sites)  #Using the scores function from vegan to extract the site scores and convert to a data.frame
cov_ndms_scores$transect <- rownames(cov_ndms_scores) # create a column of transect names
cov_ndms_scores$site <- ind_df$Site
cov_ndms_scores$depth <- ind_df$Depth  #  add the grp variable created earlier
str(cov_ndms_scores)  #look at the data


NMDS1 <- cov_nmds_br$points[,1] ##also found using: > scores(cov_nmds_br)
NMDS2 <- cov_nmds_br$points[,2]
nmds_df<-cbind(ind_df, NMDS1, NMDS2)

```

nMDS plot

```{r}

str(cov_nmds_br)

library(ggplot2)
#install.packages("ggforce")
library(ggforce)

cov_ndms_ggplot <- ggplot(nmds_df, aes(NMDS1, NMDS2))+
  geom_point(data=nmds_df, aes(NMDS1, NMDS2, color=Site, shape=depth),size=3)+##separates overlapping points
  geom_mark_ellipse(aes(fill=Site, color=Site), expand = 0)+ # https://luisdva.github.io/rstats/Grouping-points/
  theme_classic()+
  ggtitle("nMDS of relative benthic cover")+
  theme(plot.title = element_text(size=14, face="bold",hjust=.5),
        legend.title = element_text(color = "black", size = 12),
        legend.text = element_text(size=10))+
  guides(color = guide_legend(order = 1,title="Site"),
         fill = guide_legend(order = 1,title="Site"),
         shape = guide_legend(order = 2,title="Depth"))+
  annotate("text", x=-0.45, y=-0.9, 
           label=paste('Stress =',round(cov_nmds_br$stress,3)),
           size=4)+
  annotate("text", x=-0.35, y=-1,
           label=bquote('Non-metric fit,'~ R^2~"= 0.998"),
           size=4) #add goodness of fit to plot
```

Test a colorblind-friendly palette using `colorblindr` package

```{r}
#remotes::install_github("wilkelab/cowplot")
#install.packages("colorspace")
library(colorspace)

#install.packages("colorspace")
#remotes::install_github("clauswilke/colorblindr")
library(colorblindr)

palette4viridisorange=c("#440154","#2a788e","#35b779","darkorange")

cov_ndms_ggplot<- cov_ndms_ggplot+
  scale_color_manual(values= palette4viridisorange)+
  scale_fill_manual(values= palette4viridisorange)

cov_ndms_ggplot

cvd_grid(cov_ndms_ggplot)

cov_ndms_ggplot

ggsave("relcov_nmds.tiff", units="in", width=7, height=4.5, dpi=300, compression = 'lzw')
```

# PERMANOVA AND POST-HOC PAIRWISE PERMANOVA

Load libraries

```{r}
#VEGAN----
library(vegan)#load package
#install.packages("vegan3d")
library(vegan3d)
library(MASS)
library(dplyr)

#install.packages("pairwiseAdonis")
library(devtools) #to install pairwiseAdonis from GitHub
library(pairwiseAdonis)
#install.packages("Rtools")
# library(remotes) #to use install_github
# install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)

library(readxl)   # to import excel datasets
```

Load data

```{r}
#Relative benthic cover dataframe

cov_df <- read_excel("Rel_cov_input.xlsx")
str(cov_df)
cov_df$Site <-ordered(cov_df$Site,levels=c("awa", "g1", "g2", "mi", "sk", "sn", "yo", "za", "zp", "hi","s1", "s2"))
str(cov_df)
levels(cov_df$Site)
cov_df[,c(1,3,4,5)] <- lapply(cov_df[,c(1,3,4,5)], as.factor)  ## as.factor() could also be used
#cov_mat[,5] <- as.factor(cov_mat$Site_Depth) alternative for the single lines


cov_df[,6:13] <- lapply(cov_df[,6:13], as.numeric)
cov_df <- cov_df[,-c(14:21)]

str(cov_df)

```

Convert the database `cov_df`to a matrix

```{r}
cov_mat <- cov_df[,-c(1:5)]
rownames(cov_mat) <- cov_df$Transect
cov_mat <- as.matrix(cov_mat)
str(cov_mat)
class(cov_mat)
```
Create a df with explanatory (independent) variables

```{r}
library(stringr)
cov_df$Site_depth <- str_c (cov_df$Site,'_', cov_df$depth)

#create a df with the independent variables
ind_df <- as.data.frame(cov_df[,c(2,4,14)])
str(ind_df)
```

# Session info

```{r}
sessionInfo()
```

# References

```{r}
#install.packages("report")
library(report)
report(sessionInfo())
```

