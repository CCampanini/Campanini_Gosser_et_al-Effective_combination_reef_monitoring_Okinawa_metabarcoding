---
title: "Extraction of relative benthic cover at 12 sites in Okinawa"
author: "Claudia Campanini"
date: "`r Sys.Date()`"
output: html_document
---

# LOAD BASIC LIBRARIES

```{r}
library(readxl) #read xlsx files
library(tidyverse) #aggregate fc et al.
library(tidyverse)
library(dplyr)
library(MASS)
```

# IMPORT DATASHEETS FOR EACH SITE IN A SINGLE LIST OF LISTS

```{r}
files <- list.files(path = "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", pattern=".xlsx")
files
files <- files[-5]
class(files)
# Concat the directory to the file names
files <- str_c("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", files)
class(files)

#install.packages("rio")
library(rio)

plits_raw <- sapply (files, FUN = import_list,
              simplify = F, USE.NAMES = F)

names(plits_raw) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")
```
## CHECK INPUT FILES FOR NEGATIVE VALUES

```{r}
for (i in 1:12) {
    for (k in 1:length(plits_raw[[i]])) {
    print(which(plits_raw[[i]][[k]]$Cat_tot<0,arr.ind = TRUE))
  }
}
```

# CLEAN PLITS OF EACH TRANSECT

```{r}
clean_plit_fun <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.integer(x$Point)
  x$Cat_tot <-as.integer(x$Cat_tot)
  x$Func_tot <-as.integer(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

for (i in 1:12) {
  plits_raw[[i]] <- lapply (plits_raw[[i]],clean_plit_fun)
}

#alternative with map()
#for (i in 1:12) {plits_raw[[i]] <- map (plits_raw[[i]],clean_PLIT)}
```

# EXTRACT ABSOLUTE AND RELATIVE COVER FOR EACH TRANSECT

Extraction function written using dplyr package, check the following link for tidy_eval <https://dcl-prog.stanford.edu/tidy-eval-detailed.html>

```{r}
ext_fun <- function(df, group_var,summary_var) {
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
  group_by(!! group_var) %>% 
  summarise(Abs_cov=sum(!! summary_var)) %>%
  mutate(Rel_cov = round(Abs_cov/sum(Abs_cov, na.rm = T),3)) %>%
  complete(!! group_var)
    
}

plits_ext <- vector("list", 12)
for (i in 1:12) {
  plits_ext[[i]] <- lapply (plits_raw[[i]],ext_fun,
                             group_var = Category, summary_var = Cat_tot)
}

names(plits_ext) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")
```

## ADD COLUMNS NAMES TO EACH TRANSECT

Add a column with the transect name to each transect (dataframe)
```{r}
#install.packages("wrapr") #https://search.r-project.org/CRAN/refmans/wrapr/html/add_name_column.html
library(wrapr)

for (i in 1:12) {
  plits_ext[[i]] <- add_name_column(plits_ext[[i]], "Site_Rep")
}
```

Add a column with the site name to each transect (dataframe)
```{r}
sites <- c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")

for (i in 1:12) {
    for (k in 1:length(plits_ext[[i]])) {
    plits_ext[[i]][[k]]$Site <- as.factor(rep(sites[i],13))
  }
}
```

Add a column for the depth level

```{r}
add_col_fun <- function(df, site_rep) {
  site_rep <- enquo(site_rep)
  
  df %>% 
       mutate(depth = case_when(!!site_rep == 'D1' | 
                                  !!site_rep == "D2" | 
                                  !!site_rep == "D3"~ "Deep", 
                              !!site_rep == 'S1' | 
                                  !!site_rep == "S2" | 
                                  !!site_rep == "S3"~ "Shallow"))
}

for (i in 1:12) {
  plits_ext[[i]] <- lapply (plits_ext[[i]],add_col_fun,
                             site_rep= Site_Rep)
}
```

# PREPARE SINGLE DATAFRAME WITH RELATIVE COVER

Merge in a single dataframe and add site_rep and site_depth columns

```{r}
plits_ext_df <-list()
for (i in 1:12) {
  plits_ext_df[[i]] <- as.data.frame(do.call(rbind, plits_ext[[i]]))

}
plits_ext_df <- as.data.frame(do.call(rbind, plits_ext_df))

plits_ext_df[is.na(plits_ext_df)] <- 0

plits_ext_df <- plits_ext_df %>% 
  drop_na(Category) %>% ## delete rows with NA as Category
  replace(is.na(.), 0)

plits_ext_df$Transect <- paste(plits_ext_df$Site, plits_ext_df$Site_Rep, sep='_')
plits_ext_df$Site_depth <- paste(plits_ext_df$Site, plits_ext_df$depth, sep='_')
plits_ext_df<-   plits_ext_df %>% 
       mutate(Replicate = case_when(Site_Rep == "D1" | Site_Rep == "S1" ~ 1, 
                                    Site_Rep == "D2" | Site_Rep == "S2" ~ 2,
                                    Site_Rep == "D3" | Site_Rep == "S3" ~ 3))
```
## EXPORT PLIT_EXT_DF (long format)

```{r}
library("writexl")
write_xlsx(rel_cov_input,"C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/plits_ext_df.xlsx")
```


## ROTATE DF
Follow the link for explanation of dcast function https://seananderson.ca/2013/10/19/reshape/

```{r}
rel_cov_input <- plits_ext_df[,-2] #delete Abs_cov column

library(reshape2)
rel_cov_input <- dcast(rel_cov_input, 
                        Transect + Site + Site_Rep + Site + depth + Replicate  
                          ~ Category, value.var = "Rel_cov")
```

- Merge sponge to "other"
- Delete Unknown, Missing

```{r}
rel_cov_input$other <- rel_cov_input$other + rel_cov_input$sponge
rel_cov_input<- rel_cov_input[,-c(4,10,14,16,17)]
```

## ADD STANDARD DEVIATION

```{r}
rel_cov_input <- rel_cov_input %>%
  group_by(Site, depth) %>% 
  mutate(sd_alg = round(sd(algae),2),
         sd_boulder = round(sd(boulder),2),
         sd_hc = round(sd(hard_coral),2),
         sd_other = round(sd(other),2),
         sd_rubble = round(sd(rubble),2),
         sd_sand = round(sd(sand),2),
         sd_softc = round(sd(soft_coral),2),
         sd_zoanth = round(sd(zoanthids),2))
```

## EXPORT REL_COV_INPUT DATAFRAME AS EXCEL FILE

```{r}
write_xlsx(rel_cov_input,"C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/rel_cov_input.xlsx")
```


