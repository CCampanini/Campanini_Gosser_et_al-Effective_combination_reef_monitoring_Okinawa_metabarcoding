# SECTION 1: PLIT data extraction to obtain the relative benthic coverage matrix at different sites

```{r}
library(readxl) #read xlsx files
library(tidyverse) #aggregate fc et al.
library(tidyverse)
library(dplyr)
library(MASS)
```

# SUNABE

```{r}
sn <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx", 
              simplify = F, USE.NAMES = T)


SN <- lapply (sn,function(SN) {
  SN <- SN[-c(1:2),c(1:5)]
  colnames(SN) <-SN[1,]
  SN<- SN[-1,]
  SN$Point <-as.numeric(SN$Point)
  SN$Cat_tot <-as.numeric(SN$Cat_tot)
  SN$Func_tot <-as.numeric(SN$Func_tot)
  SN$Category<- factor(SN$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  SN$Functional_group<-as.factor(SN$Functional_group)
  str(SN)
  SN
})

```

```{r}
SN_EXC <- list()

for (i in seq(SN)) {
  SN_EXC[[i]] <- SN[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  SN_EXC[[i]] <- SN_EXC[[i]][!is.na(SN_EXC[[i]]$Category),]
  SN_EXC[[i]]$Rel_cov <- round(SN_EXC[[i]]$Abs_cov/sum(SN_EXC[[i]]$Abs_cov,na.rm = TRUE),3)
  str(SN_EXC)
}
names(SN_EXC) <- c("D1","D2","D3","S1","S2","S3")
```


```{r}
fileNames <- c("PLIT_AWA.xlxs", "PLIT_G2.xlsx")

myFiles <- list.files(pattern="PLIT_*\\d{2}\\.xlsx",
                      full.names=TRUE, recursive=FALSE)

myFiles <- list.files(pattern="PLIT_*.xlxs")

dataFiles <- lapply(Sys.glob("PLIT_*.xlsx"), read_excel)

dataFiles$1

for (myFiles in myFiles) {
}
```


```{r}
sn <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx", 
              simplify = F, USE.NAMES = T)
```

```{r}
sn <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_*.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_*.xlsx", 
              simplify = F, USE.NAMES = T)
```

```{r}
file.list <- list.files(pattern='*.xlsx')
file.list <- file.list[-4]
df.list <- lapply(excel_sheets(file.list), read_excel, 
                  path="C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/*.xlsx", 
                  simplify = F, USE.NAMES = T)

```     
```{r}
library(magrittr)

plits <- list()

plits$filepath <- "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/"

result <-
  list.files(
    excel_sheets(plits$filepath), 
    pattern = '*.xlsx', 
    full.names = TRUE) %>% 
  purrr::map(read_xlsx)

https://stackoverflow.com/questions/67895604/path-must-be-a-string-error-when-reading-an-xlsx-file-in-r

```

```{r}
files.list <- list.files(recursive = T, pattern = 'PLIT_*\\.xlsx')  #get files list from folder

file.list <- list.files(pattern='*.xlsx')
file.list <- file.list[-4]

for (i in seq_along(file.list)){
  
  sheet_nm <- excel_sheets(file.list[i])

    for (j in seq_along(sheet_nm)){
  
      assign(x = sheet_nm[j], value = read_xlsx(path = file.list[i], sheet = sheet_nm[j]), envir = .GlobalEnv)
  }

}

file.list$path = c()

for (i in seq_along(file.list)){
all <- sapply (excel_sheets(file.list[i]), 
              read_excel, 
              path= file.list[i], 
              simplify = F, USE.NAMES = T)
}


https://stackoverflow.com/questions/70932647/reading-all-sheets-in-multiple-excel-files-into-r

```
```{r}
for (file in file.list){
all <- sapply (excel_sheets(file), 
              read_excel, 
              path= file, 
              simplify = F, USE.NAMES = T)
}
```



```{r}

https://stackoverflow.com/questions/14958516/read-all-files-in-directory-and-apply-multiple-functions-to-each-data-frame

file.list <- list.files(pattern='*.xlsx')
file.list <- file.list[-4]

lapply(file.list, function(x) {
    t <- read.table(x, header=TRUE) # load file
    # apply function
    out <- function(t)
    # write to file
    write.table(out, "path/to/output", sep="\t", quote=FALSE, row.names=FALSE, col.names=TRUE)
})
```

# LOAD THE PLITs FOR EVERY SITE CREATING A LIST WITH 6 TIBBLES (DATAFRAME) FOR EACH FILE 

```{r}
sn <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx", 
              simplify = F, USE.NAMES = T)

awa <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_AWA.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_AWA.xlsx", 
              simplify = F, USE.NAMES = T)

g1 <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_G1.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_G1.xlsx", 
              simplify = F, USE.NAMES = T)

g2 <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_G2.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_G2.xlsx", 
              simplify = F, USE.NAMES = T)

mi <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_MI.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_MI.xlsx", 
              simplify = F, USE.NAMES = T)

sk <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SK.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SK.xlsx", 
              simplify = F, USE.NAMES = T)

hi <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_HI.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_HI.xlsx", 
              simplify = F, USE.NAMES = T)

s1 <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_S1.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_S1.xlsx", 
              simplify = F, USE.NAMES = T)

s2 <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_S2.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_S2.xlsx", 
              simplify = F, USE.NAMES = T)

yo <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_YO.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_YO.xlsx", 
              simplify = F, USE.NAMES = T)

za <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_ZA.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_ZA.xlsx", 
              simplify = F, USE.NAMES = T)

zp <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_ZP.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_ZP.xlsx", 
              simplify = F, USE.NAMES = T)
```
```{r}
site_list <- list(awa, g1, g2, hi, mi, s1, s2, sk, sn, yo, za, zp)

site_names <- c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")

names(site_list) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")

for (i in seq_along(site_list)) {
   assign(names[i],df)


for (i in seq_along(site_list)) {

site_exc[[i]] <- lapply (site_list[[i]],function(site_exc) {
  site_exc[[i]] <- site_exc[-c(1:2),c(1:5)]
  colnames(site_exc[[i]]) <-site_exc[1,]
  site_exc[[i]]<- site_exc[-1,]
  site_exc[[i]]$Point <-as.numeric(site_exc[[i]]$Point)
  site_exc[[i]]$Cat_tot <-as.numeric(site_exc[[i]]$Cat_tot)
  site_exc[[i]]$Func_tot <-as.numeric(site_exc[[i]]$Func_tot)
  site_exc[[i]]$Category<- factor(site_exc[[i]]$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  site_exc[[i]]$Functional_group<-as.factor(site_exc[[i]]$Functional_group)
  str(site_exc[[i]])
  site_exc[[i]]
})  

}


for (i in seq(SN)) {
  SN_EXC[[i]] <- SN[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  SN_EXC[[i]] <- SN_EXC[[i]][!is.na(SN_EXC[[i]]$Category),]
  SN_EXC[[i]]$Rel_cov <- round(SN_EXC[[i]]$Abs_cov/sum(SN_EXC[[i]]$Abs_cov,na.rm = TRUE),3)
  str(SN_EXC)
}
  

for (i in seq_along(site_list)) {
  for (j in 1:6) {

site_exc[[i]] <- lapply (site_list[[i]][[j]],function(site_exc) {
  site_exc[[i]] <- site_exc[-c(1:2),c(1:5)]
  colnames(site_exc[[i]]) <-site_exc[1,]
  site_exc[[i]]<- site_exc[-1,]
  site_exc[[i]]$Point <-as.numeric(site_exc[[i]]$Point)
  site_exc[[i]]$Cat_tot <-as.numeric(site_exc[[i]]$Cat_tot)
  site_exc[[i]]$Func_tot <-as.numeric(site_exc[[i]]$Func_tot)
  site_exc[[i]]$Category<- factor(site_exc[[i]]$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  site_exc[[i]]$Functional_group<-as.factor(site_exc[[i]]$Functional_group)
  str(site_exc[[i]])
  site_exc[[i]]
})  

}
}
```


```{r}
files <- list.files(path = "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", pattern=".xlsx")
files
files <- files[-5]
class(files)
# Concat the directory to the file names
files <- str_c("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", files)
class(files)



```
```{r}

files <- as.data.frame(files)


prova <- sapply (excel_sheets(files), read_excel,
              simplify = F, USE.NAMES = T)


```

#IMPORT ALL PLITs FOR EVERY SITE CREATING A LIST WITH 6 DATAFRAMES FOR EACH FILE WITH import_list FROM RIO

https://www.geeksforgeeks.org/how-to-read-a-xlsx-file-with-multiple-sheets-in-r/

```{r}

###
install.packages("rio")
library(rio)

sites <- import_list("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_YO.xlsx" )

prova2 <- sapply (files, FUN = import_list,
              simplify = F, USE.NAMES = F)
names(prova2) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")
```


```{r}

prova2.1 <- lapply (prova2[[1]],function(prova2.1) {
  prova2.1 <- prova2.1[-c(1:2),c(1:5)]
  colnames(prova2.1) <-prova2.1[1,]
  prova2.1<- prova2.1[-1,]
  prova2.1$Point <-as.numeric(prova2.1$Point)
  prova2.1$Cat_tot <-as.numeric(prova2.1$Cat_tot)
  prova2.1$Func_tot <-as.numeric(prova2.1$Func_tot)
  prova2.1$Category<- factor(prova2.1$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  prova2.1$Functional_group<-as.factor(prova2.1$Functional_group)
  str(prova2.1)
  prova2.1
})

for (i in 1:12) {
  
prova2.2[[i]] <- lapply (prova2[[i]],function(prova2.2[[i]]) {
  prova2.2[[i]] <- prova2.2[[i]][-c(1:2),c(1:5)]
  colnames(prova2.1) <-prova2.2[[i]][1,]
  prova2.2[[i]]<- prova2.2[[i]][-1,]
  prova2.2[[i]]$Point <-as.numeric(prova2.2[[i]]$Point)
  prova2.2[[i]]$Cat_tot <-as.numeric(prova2.2[[i]]$Cat_tot)
  prova2.2[[i]]$Func_tot <-as.numeric(prova2.2[[i]]$Func_tot)
  prova2.2[[i]]$Category<- factor(prova2.2[[i]]$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  prova2.1$Functional_group<-as.factor(prova2.1$Functional_group)
  str(prova2.1)
  prova2.1
})


clean_PLIT <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.numeric(x$Point)
  x$Cat_tot <-as.numeric(x$Cat_tot)
  x$Func_tot <-as.numeric(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

prova2[[1]] <- lapply (prova2[[1]],clean_PLIT)
prova2[[2]] <- lapply (prova2[[2]],clean_PLIT)


for (i in 3:12) {
  prova2[[i]] <- lapply (prova2[[i]],clean_PLIT)
}




extraction <- function(x,y) {
  y <- x %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  y <- y[!is.na(x$Category),]
  y$Rel_cov <- round(y$Abs_cov/sum(y$Abs_cov,na.rm = TRUE),3)
  str(y)
  }

prova4 <- lapply (prova3, extraction, x = prova3[[1]])

```

# IMPORT DATASHEETS IN A BIG ASS LIST
```{r}
install.packages("rio")
library(rio)

sites <- import_list("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_YO.xlsx" )

prova2 <- sapply (files, FUN = import_list,
              simplify = F, USE.NAMES = F)

names(prova2) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")
```
```

# CLEAN PLITS OF EACH TRANSECT

```{r}
clean_PLIT <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.integer(x$Point)
  x$Cat_tot <-as.integer(x$Cat_tot)
  x$Func_tot <-as.integer(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

for (i in 1:12) {
  prova2[[i]] <- lapply (prova2[[i]],clean_PLIT)
}
```

# extract all

```{r}
extraction <- function(x,y) {
  y <- x %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  y <- y[!is.na(x$Category),]
  y$Rel_cov <- round(y$Abs_cov/sum(y$Abs_cov,na.rm = TRUE),3)
  str(y)
  }

sum2 <- prova2[[1]][[1]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  sum2 <- sum2[!is.na(x$Category),]
  sum2$Rel_cov <- round(sum2$Abs_cov/sum(sum2$Abs_cov,na.rm = TRUE),3)
  str(sum2)

for (i in 1:12) {
  for (j in 1:6) {  
  sum22 <- lapply (prova2[[i]][[j]],extraction)
  }
}  
```

