---
title: "PLIT_relcov_extraction_notes"
author: "Claudia Campanini"
date: "`r Sys.Date()`"
output: html_document
---
# SECTION 1: PLIT data extraction to obtain the relative benthic coverage matrix at different sites

```{r}
library(readxl) #read xlsx files
library(tidyverse) #aggregate fc et al.
library(tidyverse)
library(dplyr)
library(MASS)
```

# SUNABE

## D1

```{r}
SN_D1<- read_excel("PLIT_SN.xlsx", sheet = "D1")
class(SN_D1)
SN_D1<- SN_D1[-c(1:2),c(1:5)]
colnames(SN_D1) <-SN_D1[1,]
SN_D1<- SN_D1[-1,]
str(SN_D1)
SN_D1$Point <-as.numeric(SN_D1$Point)
SN_D1$Cat_tot <-as.numeric(SN_D1$Cat_tot)
SN_D1$Func_tot <-as.numeric(SN_D1$Func_tot)
SN_D1$Category<- factor(SN_D1$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
SN_D1$Functional_group<-as.factor(SN_D1$Functional_group)

str(SN_D1)
```
```{r}
SN_D1_cov <- SN_D1 %>%
  group_by(Category) %>% 
  summarise(Abs_cov=sum(Cat_tot)) %>%
  complete(Category)

SN_D1_cov <- SN_D1_cov[!is.na(SN_D1_cov$Category),]

SN_D1_cov$Rel_cov <- round(SN_D1_cov$Abs_cov/sum(SN_D1_cov$Abs_cov,na.rm = TRUE),3)
str(SN_D1_cov)
```
```{r}
mysheetlist <- excel_sheets(path="C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx")

mysheetlist <- as.factor(mysheetlist)
levels(mysheetlist)
mysheetlist <- mysheetlist[-"METADATA"]
mysheetlist <- mysheetlist[! mysheetlist %in% "METADATA"]


for (i in mysheetlist) {
 assign(paste0("SN",i),
        read_excel(path="C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx", sheet = i),)
}

sn <- sapply (excel_sheets("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx"), read_excel, 
              path= "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_SN.xlsx", 
              simplify = F, USE.NAMES = T)


SN <- lapply (sn,function(SN) {
  SN <- SN[-c(1:2),c(1:5)]
  colnames(SN) <-SN[1,]
  SN<- SN[-1,]
  SN$Point <-as.numeric(SN$Point)
  SN$Cat_tot <-as.numeric(SN$Cat_tot)
  SN$Func_tot <-as.numeric(SN$Func_tot)
  SN$Category<- factor(SN$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  SN$Functional_group<-as.factor(SN$Functional_group)
  str(SN)
  SN
})

```

# IMPORT DATASHEETS IN A BIG ASS LIST
```{r}
files <- list.files(path = "C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", pattern=".xlsx")
files
files <- files[-5]
class(files)
# Concat the directory to the file names
files <- str_c("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/", files)
class(files)

#install.packages("rio")
library(rio)

sites <- import_list("C:/Users/claud/Documents/COMUNE/STUDIO.LAVORO/IMBRSea/Thesis/StatAnalysis/Multi-taxa_data/PLITs/extraction/PLIT_YO.xlsx" )

prova2 <- sapply (files, FUN = import_list,
              simplify = F, USE.NAMES = F)

names(prova2) = c("awa", "g1", "g2", "hi", "mi", "s1", "s2", "sk", "sn", "yo", "za", "zp")
```

# CLEAN PLITS OF EACH TRANSECT

```{r}
clean_PLIT <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.integer(x$Point)
  x$Cat_tot <-as.integer(x$Cat_tot)
  x$Func_tot <-as.integer(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

for (i in 1:12) {
  prova2[[i]] <- lapply (prova2[[i]],clean_PLIT)
}
```

# TRIALS

Try function on one site with dplyr

```{r}
sn <- prova2[[9]]

SN_EXC <- list()

for (i in seq(sn)) {
  SN_EXC[[i]] <- sn[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  SN_EXC[[i]] <- SN_EXC[[i]][!is.na(SN_EXC[[i]]$Category),]
  SN_EXC[[i]]$Rel_cov <- round(SN_EXC[[i]]$Abs_cov/sum(SN_EXC[[i]]$Abs_cov,na.rm = TRUE),3)
  str(SN_EXC)
}
names(SN_EXC) <- c("D1","D2","D3","S1","S2","S3")
```

Try with one transect from 1 site

```{r}
sn_d1_ext <- sn[[1]] %>%
    group_by(!! Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  sn_d1_ext[[1]] <- sn_d1_ext[1][!is.na(sn_d1_ext[[1]]$Category),]
  sn_d1_ext[[1]]$Rel_cov <- round(sn_d1_ext[[1]]$Abs_cov/sum(sn_d1_ext[[1]]$Abs_cov,na.rm = TRUE),3)
  str(sn_d1_ext)
```


Try function on one site with aggregate

```{r}
sn_ext <-list()
for (i in 1:6) {
  sn_ext[[i]] <- data.frame(aggregate(Cat_tot ~ Category, sn[[i]], sum))
  names(sn_ext[[i]][2]) <-"Abs_cov"
  sn_ext[[i]]$Rel_cov <- as.numeric(round(sn_ext[[i]]$Abs_cov/sum(sn_ext[[i]]$Abs_cov),3))
  str(sn_ext[[i]])
  sum(sn_ext[[i]]$Rel_cov)
  sn_ext[[i]] <- sn_ext[[i]] %>% complete(Category)
}
```

```{r}
sn_d1_ext_agg <- data.frame(aggregate(Cat_tot ~ Category, sn[[1]], sum))
  names(sn_d1_ext_agg$Cat_tot) <-"Abs_cov"
  sn_ext[[i]]$Rel_cov <- as.numeric(round(sn_ext[[i]]$Abs_cov/sum(sn_ext[[i]]$Abs_cov),3))
  str(sn_ext[[i]])
  sum(sn_ext[[i]]$Rel_cov)
  sn_ext[[i]] <- sn_ext[[i]] %>% complete(Category)
```

Try by creating an extraction function

```{r}
ext_PLIT <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.integer(x$Point)
  x$Cat_tot <-as.integer(x$Cat_tot)
  x$Func_tot <-as.integer(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

ext_PLIT <- function(x) {
  x <- data.frame(aggregate(Cat_tot ~ Category, x, sum))
  names(x$Cat_tot) <-"Abs_cov"
}

for (i in 1:12) {
  prova2[[i]] <- lapply (prova2[[i]],ext_PLIT)
}
```

```{r}
ext_PLIT2 <- function(x) {
    x <- x %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  x <- x[!is.na(x$Category),]
  x$Rel_cov <- round(x$Abs_cov/sum(x$Abs_cov,na.rm = TRUE),3)
  str(x)
}

awa_ext2 <- list() 
hi_ext3<- capture.output(lapply(hi,ext_PLIT2))
 
prova3 <- prova2[-8]
  
for (i in 1:12) {
  prova3[[i]] <- lapply (prova3[[i]],ext_PLIT2)
}

names(SN_EXC) <- c("D1","D2","D3","S1","S2","S3")
```


```{r}
ext_PLIT3 <- function(x,y) {
    y <- x %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  y <- y[!is.na(y$Category),]
  y$Rel_cov <- round(y$Abs_cov/sum(y$Abs_cov,na.rm = TRUE),3)
  str(y)
}

hi_ext3<- lapply(hi,ext_PLIT3)

str(hi_ext3)
                 
capture.output(lapply(g1,ext_PLIT3))
```

## trial with map

```{r}
clean_PLIT <- function(x) {
  x <- x[-c(1:2),c(1:5)]
  colnames(x) <-x[1,]
  x<- x[-1,]
  x$Point <-as.integer(x$Point)
  x$Cat_tot <-as.integer(x$Cat_tot)
  x$Func_tot <-as.integer(x$Func_tot)
  x$Category<- factor(x$Category, levels= c("algae","boulder","hard_coral","missing","other","rubble","sand",
                "shadow","soft_coral","sponge","unknown","zoanthids"))
  x$Functional_group<-as.factor(x$Functional_group)
  str(x)
  x
}

prova_map <- map(prova2,clean_PLIT)


for (i in 1:12) {
  prova2[[i]] <- map (prova2[[i]],clean_PLIT)
}
```
## trial to write extraction function with enquo 
https://dcl-prog.stanford.edu/tidy-eval-detailed.html

```{r}
ext_PLIT4 <- function(df, group_var,summary_var) {
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
  group_by(!! group_var) %>% 
  summarise(Abs_cov=sum(!! summary_var)) %>%
  complete(!! group_var)
  
  
}

awa_ext4_D1 <- map (awa,ext_PLIT4)

awa_ext4_D1 <- ext_PLIT4(df = awa[[1]], group_var = Category, summary_var = Cat_tot)

awa_ext4 <- lapply(awa, FUN = ext_PLIT4,group_var = Category, summary_var = Cat_tot)

ext_PLIT5 <- function(df, group_var,summary_var) {
  group_var <- enquo(group_var)
  summary_var <- enquo(summary_var)
  
  df %>%
  group_by(!! group_var) %>% 
  summarise(Abs_cov=sum(!! summary_var)) %>%
  mutate(Rel_cov = round(Abs_cov/sum(Abs_cov, na.rm = T),3)) %>%
  complete(!! group_var)
    
}

awa_ext5 <- lapply(awa, FUN = ext_PLIT5,group_var = Category, summary_var = Cat_tot)

prova_ext5 <- vector("list", 12)
for (i in 1:12) {
  prova_ext5[[i]] <- lapply (prova2[[i]],ext_PLIT5,
                             group_var = Category, summary_var = Cat_tot)
}

prova_ext5[[1]] <- lapply(prova2[[1]], FUN = ext_PLIT5,
                          group_var = Category, summary_var = Cat_tot)
prova_ext5[[2]] <- lapply(prova2[[2]], FUN = ext_PLIT5,
                          group_var = Category, summary_var = Cat_tot)
prova_ext5[[2]] <- lapply(prova2[[2]], FUN = ext_PLIT5,
                          group_var = Category, summary_var = Cat_tot)

```



## SOLUTION ONE SITE PER TIME

Repeat for every site dataset until I found an iterative solution

```{r}
awa <- prova2[[1]]
g1 <- prova2[[2]]
g2 <- prova2[[3]]
hi <- prova2[[4]]
mi <- prova2[[5]]
s1 <- prova2[[6]]
s2 <- prova2[[7]]
sk <- prova2[[8]]
sn <- prova2[[9]]
yo <- prova2[[10]]
za <- prova2[[11]]
zp <- prova2[[12]]

#AWA
awa_ext <- list()
for (i in seq(awa)) {
  awa_ext[[i]] <- awa[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  awa_ext[[i]] <- awa_ext[[i]][!is.na(awa_ext[[i]]$Category),]
  awa_ext[[i]]$Rel_cov <- round(awa_ext[[i]]$Abs_cov/sum(awa_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(awa_ext)
}
names(awa_ext) <- c("D1","D2","D3","S1","S2","S3")

#G1
for (i in seq(g1)) {
  g1_ext[[i]] <- g1[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  g1_ext[[i]] <- g1_ext[[i]][!is.na(g1_ext[[i]]$Category),]
  g1_ext[[i]]$Rel_cov <- round(g1_ext[[i]]$Abs_cov/sum(g1_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(g1_ext)
}
names(g1_ext) <- c("D1","D2","D3","S1","S2","S3")


#G2
for (i in seq(g2)) {
  g2_ext[[i]] <- g2[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  g2_ext[[i]] <- g2_ext[[i]][!is.na(g2_ext[[i]]$Category),]
  g2_ext[[i]]$Rel_cov <- round(g2_ext[[i]]$Abs_cov/sum(g2_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(g2_ext)
}
names(g2_ext) <- c("D1","D2","D3","S1","S2","S3")


#HI
for (i in seq(hi)) {
  hi_ext[[i]] <- hi[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  hi_ext[[i]] <- hi_ext[[i]][!is.na(hi_ext[[i]]$Category),]
  hi_ext[[i]]$Rel_cov <- round(hi_ext[[i]]$Abs_cov/sum(hi_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(hi_ext)
}
names(hi_ext) <- c("D1","D2","D3","S1","S2","S3")


#MI 
for (i in seq(mi)) {
  mi_ext[[i]] <- mi[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  mi_ext[[i]] <- mi_ext[[i]][!is.na(mi_ext[[i]]$Category),]
  mi_ext[[i]]$Rel_cov <- round(mi_ext[[i]]$Abs_cov/sum(mi_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(mi_ext)
}
names(mi_ext) <- c("D1","D2","D3","S1","S2","S3")

#S1
for (i in seq(s1)) {
  s1_ext[[i]] <- s1[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  s1_ext[[i]] <- s1_ext[[i]][!is.na(s1_ext[[i]]$Category),]
  s1_ext[[i]]$Rel_cov <- round(s1_ext[[i]]$Abs_cov/sum(s1_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(s1_ext)
}
names(s1_ext) <- c("D1","D2","D3","S1","S2","S3")

#S2
for (i in seq(s2)) {
  s2_ext[[i]] <- s2[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  s2_ext[[i]] <- s2_ext[[i]][!is.na(s2_ext[[i]]$Category),]
  s2_ext[[i]]$Rel_cov <- round(s2_ext[[i]]$Abs_cov/sum(s2_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(s2_ext)
}
names(s2_ext) <- c("D1","D2","D3","S1","S2","S3")

#SN
for (i in seq(sn)) {
  sn_ext[[i]] <- sn[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  sn_ext[[i]] <- sn_ext[[i]][!is.na(sn_ext[[i]]$Category),]
  sn_ext[[i]]$Rel_cov <- round(sn_ext[[i]]$Abs_cov/sum(sn_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(sn_ext)
}
names(sn_ext) <- c("D1","D2","D3","S1","S2","S3")

#YO
for (i in seq(yo)) {
  yo_ext[[i]] <- yo[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  yo_ext[[i]] <- yo_ext[[i]][!is.na(yo_ext[[i]]$Category),]
  yo_ext[[i]]$Rel_cov <- round(yo_ext[[i]]$Abs_cov/sum(yo_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(yo_ext)
}
names(yo_ext) <- c("D1","D2","D3","S1","S2","S3")

#ZA
for (i in seq(za)) {
  za_ext[[i]] <- za[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  za_ext[[i]] <- za_ext[[i]][!is.na(za_ext[[i]]$Category),]
  za_ext[[i]]$Rel_cov <- round(za_ext[[i]]$Abs_cov/sum(za_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(za_ext)
}
names(za_ext) <- c("D1","D2","D3","S1","S2","S3")

#ZP
for (i in seq(zp)) {
  zp_ext[[i]] <- zp[[i]] %>%
    group_by(Category) %>% 
    summarise(Abs_cov=sum(Cat_tot)) %>%
    complete(Category)
  zp_ext[[i]] <- zp_ext[[i]][!is.na(zp_ext[[i]]$Category),]
  zp_ext[[i]]$Rel_cov <- round(zp_ext[[i]]$Abs_cov/sum(zp_ext[[i]]$Abs_cov,na.rm = TRUE),3)
  str(zp_ext)
}
names(zp_ext) <- c("D1","D2","D3","S1","S2","S3")
```


